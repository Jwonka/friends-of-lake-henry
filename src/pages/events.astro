---
import BaseLayout from "../layouts/BaseLayout.astro";
import type { D1Database } from "@cloudflare/workers-types";
export const prerender = false;

type EventRow = {
    id: string;
    title: string;
    kind: string;
    status: string;
    date_start: string | null;
    date_end: string | null;
    is_tbd: number;
    location: string | null;
    summary: string | null;
    url: string | null;
    url_label: string | null;
    poster_key: string | null;
    poster_alt: string | null;
};

type WeekdayShort = "Sun" | "Mon" | "Tue" | "Wed" | "Thu" | "Fri" | "Sat";

const WEEKDAY_INDEX: Record<WeekdayShort, number> = {
    Sun: 0,
    Mon: 1,
    Tue: 2,
    Wed: 3,
    Thu: 4,
    Fri: 5,
    Sat: 6,
};

const env = (Astro.locals as any).runtime?.env as { DB?: D1Database } | undefined;
const DB = env?.DB;
if (!DB) throw new Error("DB binding missing (Astro.locals.runtime.env.DB).");

const TZ = "America/Chicago";

function monthLabelFromKey(monthKey: string) {
    const [y, m] = monthKey.split("-").map(Number);
    const d = new Date(Date.UTC(y, m - 1, 15, 12)); // mid-month, noon UTC avoids DST edges
    return new Intl.DateTimeFormat("en-US", {
        timeZone: TZ,
        month: "long",
        year: "numeric",
    }).format(d);
}

function fmtNiceDateSSR(dateStr: string | null) {
    if (!dateStr) return "Date TBD";
    const d = new Date(dateStr);
    if (Number.isNaN(d.getTime())) return "Date TBD";
    return new Intl.DateTimeFormat("en-US", {
        timeZone: TZ,
        weekday: "short",
        month: "short",
        day: "numeric",
    }).format(d);
}

function fmtNiceTimeSSR(dateStr: string | null) {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    if (Number.isNaN(d.getTime())) return null;
    return new Intl.DateTimeFormat("en-US", {
        timeZone: TZ,
        hour: "numeric",
        minute: "2-digit",
    }).format(d).replace(":00", "");
}

function monthKey(year: number, monthIndex: number) {
    return `${year}-${String(monthIndex + 1).padStart(2, "0")}`;
}

function dayKeyChicagoFromDateStart(dateStr: string | null) {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    if (Number.isNaN(d.getTime())) return null;

    // YYYY-MM-DD in America/Chicago
    return new Intl.DateTimeFormat("en-CA", {
        timeZone: TZ,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
    }).format(d);
}

function isMonthKey(s: string) {
    return /^\d{4}-\d{2}$/.test(s);
}

function chicagoCurrentMonthKey(d = new Date()) {
    return new Intl.DateTimeFormat("en-CA", {
        timeZone: "America/Chicago",
        year: "numeric",
        month: "2-digit",
    }).format(d).slice(0, 7);
}

function chicagoWeekdayIndexForMonthStart(monthKeyStr: string) {
    const [y, m] = monthKeyStr.split("-").map(Number);

    // Anchor at UTC noon on the 1st to avoid DST edges
    const first = new Date(Date.UTC(y, m - 1, 1, 12));

    const wk = new Intl.DateTimeFormat("en-US", {
        timeZone: TZ,
        weekday: "short",
    }).format(first) as WeekdayShort;

    return WEEKDAY_INDEX[wk];
}

const url = new URL(Astro.request.url);
const monthParamRaw = (url.searchParams.get("month") ?? "").trim();

const currentMonthKey = chicagoCurrentMonthKey(new Date());

// 1) Build allowed months from DB (data months) + current month
const monthsRes = await DB.prepare(`
  SELECT DISTINCT substr(date_start, 1, 7) AS monthKey
  FROM events
  WHERE status = 'published'
    AND is_tbd = 0
    AND date_start IS NOT NULL
    AND date_start != ''
  ORDER BY monthKey DESC
`).all();

const dbMonths = (monthsRes.results ?? [])
    .map((r: any) => String(r.monthKey ?? "").trim())
    .filter(isMonthKey);

const months = Array.from(new Set([currentMonthKey, ...dbMonths]))
    .sort((a, b) => b.localeCompare(a)); // DESC

const activeMonths = dbMonths.slice().sort((a, b) => b.localeCompare(a)); // DESC
const defaultMonthKey = activeMonths[0] ?? currentMonthKey;

// 2) Choose SSR month (clamp to allowed)
let ssrMonthKey = defaultMonthKey;
if (isMonthKey(monthParamRaw) && months.includes(monthParamRaw)) {
    ssrMonthKey = monthParamRaw;
}
if (!months.includes(ssrMonthKey)) ssrMonthKey = months[0] ?? currentMonthKey;

// 3) Prev/Next restricted to allowed months
const idx = months.indexOf(ssrMonthKey);
const prevMonthKey = idx >= 0 && idx + 1 < months.length ? months[idx + 1] : null;
const nextMonthKey = idx > 0 ? months[idx - 1] : null;

// 4) Use ssrMonthKey for calendar math + queries
const [yearStr, monthStr] = ssrMonthKey.split("-");
const year = Number(yearStr);
const monthIndex = Number(monthStr) - 1;

const nextMonth = new Date(year, monthIndex + 1, 1);

const monthStartISO = `${ssrMonthKey}-01`;
const nextMonthStartISO = `${monthKey(nextMonth.getFullYear(), nextMonth.getMonth())}-01`;

const dow = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
const startDow = chicagoWeekdayIndexForMonthStart(ssrMonthKey);
const daysInMonth = new Date(Date.UTC(year, monthIndex + 1, 0, 12)).getUTCDate();

// Query: month events (published, not TBD, within month)
const monthRes = await DB.prepare(`
  SELECT id, title, kind, status, date_start, date_end, is_tbd,
         location, summary, url, url_label, poster_key, poster_alt
  FROM events
  WHERE status = 'published'
    AND is_tbd = 0
    AND date_start IS NOT NULL
    AND date_start != ''
    AND date_start >= ?
    AND date_start < ?
  ORDER BY date_start ASC, title ASC
`).bind(monthStartISO, nextMonthStartISO).all<EventRow>();

const monthEvents = monthRes.results ?? [];

// Query: TBD events (published + is_tbd OR missing date_start)
const tbdRes = await DB.prepare(`
  SELECT id, title, kind, status, date_start, date_end, is_tbd,
         location, summary, url, url_label, poster_key, poster_alt
  FROM events
  WHERE status = 'published'
    AND (is_tbd = 1 OR date_start IS NULL OR date_start = '')
  ORDER BY updated_at DESC, title ASC
`).all<EventRow>();

const tbdEvents = tbdRes.results ?? [];

// Bucket month events by day
const byDay = new Map<string, EventRow[]>();
for (const e of monthEvents) {
    const key = dayKeyChicagoFromDateStart(e.date_start);
    if (!key) continue;
    const arr = byDay.get(key) ?? [];
    arr.push(e);
    byDay.set(key, arr);
}
---

<BaseLayout title="Events | Friends of Lake Henry">
    <div class="container">
        <section class="card pad enter-block">
            <h1>Events</h1>
            <p class="lead">
                Upcoming events, raffles, and community opportunities to support Lake Henry.
            </p>

            <div class="panel calendarPanel enter-block delay-1" aria-label="Events calendar">
                <div class="calHead">
                    <div>
                        <h2 class="h2-zero" id="eventsMonthLabel">{monthLabelFromKey(ssrMonthKey)}</h2>
                        <div class="muted calHint" id="eventsMonthHint">
                            {monthEvents.length === 0
                                ? "No published events this month yet."
                                : monthEvents.length === 1
                                    ? "1 published event this month."
                                    : `${monthEvents.length} published events this month.`}
                        </div>
                    </div>
                    <div class="calNav">
                        <button class="pill" id="eventsPrevBtn" type="button" aria-label="Previous month">← Prev</button>

                        <label class="srOnly" for="eventsMonthSelect">Select month</label>
                        <select id="eventsMonthSelect" class="monthSelect">
                            {months.map((m) => (
                                    <option value={m} selected={m === ssrMonthKey}>{monthLabelFromKey(m)}</option>
                            ))}
                        </select>

                        <button class="pill" id="eventsNextBtn" type="button" aria-label="Next month">Next →</button>
                    </div>
                </div>
                <p id="eventsAjaxStatus" class="srOnly" aria-live="polite"></p>
                <div class="calendarWrap" aria-hidden="false">
                    <div class="calendar" id="eventsCalendarGrid" role="grid" aria-label={`Calendar for ${monthLabelFromKey(ssrMonthKey)}`}>
                        {dow.map((d) => (
                                <div class="dow" role="columnheader">{d}</div>
                        ))}

                        {Array.from({ length: startDow }).map(() => (
                                <div class="cell blank" aria-hidden="true"></div>
                        ))}

                        {Array.from({ length: daysInMonth }).map((_, idx) => {
                            const day = idx + 1;
                            const iso = `${monthKey(year, monthIndex)}-${String(day).padStart(2, "0")}`;
                            const dayEvents = byDay.get(iso) ?? [];
                            return (
                                <div class="cell" role="gridcell">
                                    <div class="dayNum">{day}</div>

                                    {dayEvents.length ? (
                                        <div class="chips">
                                            {dayEvents.slice(0, 3).map((ev) => (
                                                <a
                                                    class="chip"
                                                    href={`#event-${ev.id}`}
                                                    aria-disabled="false"
                                                    title={ev.summary ?? ev.title}
                                                >
                                                    <span class="chipKind">{ev.kind}</span>
                                                    <span class="chipTitle">{ev.title}</span>
                                                </a>
                                            ))}
                                            {dayEvents.length > 3 ? (
                                                <div class="muted small">+{dayEvents.length - 3} more</div>
                                            ) : null}
                                        </div>
                                    ) : (
                                        <div class="muted empty">—</div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>

                {/* Month list (good for readability + mobile + SEO) */}
                {monthEvents.length > 0 && (
                    <div class="monthList" id="eventsMonthListWrap">
                        <div class="list" id="eventsMonthList">
                            {monthEvents.map((e) => {
                                const nice = fmtNiceDateSSR(e.date_start);
                                const time = fmtNiceTimeSSR(e.date_start);

                                return (
                                    <details class="panel item eventDetails" id={`event-${e.id}`}>
                                        <summary class="eventSummary">
                                            <div class="meta">
                                                <div class="title">{e.title}</div>
                                                <div class="sub">
                                                    {nice}{time ? ` • ${time}` : ""}
                                                    {e.location ? <span> • {e.location}</span> : null}
                                                </div>
                                            </div>
                                            <span class="pillMini">{e.kind}</span>
                                        </summary>

                                        <div class="eventBody">
                                            {e.summary ? <p class="summary">{e.summary}</p> : null}

                                            {/* Poster (later: wire poster_key to an image endpoint) */}
                                            {e.poster_key ? (
                                                <figure class="poster">
                                                    <img src={`/api/events/poster?id=${e.id}`} alt={e.poster_alt ?? e.title} loading="lazy" />
                                                </figure>
                                            ) : null}

                                            {(() => {
                                                let href: string | null = null;
                                                try {
                                                    if (e.url) {
                                                        const u = new URL(e.url, Astro.url.origin);
                                                        if (u.protocol === "http:" || u.protocol === "https:") href = u.toString();
                                                    }
                                                } catch {}
                                                return href ? (
                                                    <p style="margin: .75rem 0 0;">
                                                        <a class="pill" href={href} target="_blank" rel="noopener noreferrer">
                                                            {e.url_label ?? "Details"}
                                                        </a>
                                                    </p>
                                                ) : null;
                                            })()}
                                        </div>
                                    </details>
                                );
                            })}
                        </div>
                    </div>
                )}
            </div>

            {/* TBD */}
            <div class="panel enter-block delay-2" style="margin-top: var(--section-gap);">
                <h2 class="h2-zero">To be announced</h2>
                <p class="muted" style="margin: .35rem 0 1rem;">
                    {tbdEvents.length === 0
                        ? "No TBD events right now."
                        : tbdEvents.length === 1
                            ? "1 event doesn’t have a confirmed date yet."
                            : `${tbdEvents.length} events don’t have a confirmed date yet.`}
                </p>

                {tbdEvents.length > 0 && (
                    <div class="list">
                        {tbdEvents.map((e) => (
                            <article class="panel item">
                                <div class="meta">
                                    <div class="title">{e.title}</div>
                                    <div class="sub">
                                        <span class="pillMini">TBD</span>
                                        {e.location ? <span> • {e.location}</span> : null}
                                    </div>
                                </div>
                                {e.summary ? <p class="summary">{e.summary}</p> : null}
                                {(() => {
                                    let href: string | null = null;
                                    try {
                                        if (e.url) {
                                            const u = new URL(e.url, Astro.url.origin);
                                            if (u.protocol === "http:" || u.protocol === "https:") {
                                                href = u.toString();
                                            }
                                        }
                                    } catch {}

                                    return href ? (
                                        <p style="margin: .75rem 0 0;">
                                            <a class="pill" href={href} target="_blank" rel="noopener noreferrer">
                                                {e.url_label ?? "Details"}
                                            </a>
                                        </p>
                                    ) : null;
                                })()}
                            </article>
                        ))}
                    </div>
                )}
            </div>
        </section>
    </div>
    <script
            id="eventsInitialState"
            type="application/json"
            set:html={JSON.stringify({
                monthKey: ssrMonthKey,
                prevMonthKey,
                nextMonthKey,
            })}
    ></script>
    <script type="module">
        const tz = "America/Chicago";

        /**
         * @typedef {{id:string, title:string, kind:string, date_start:string|null, location:string|null, summary:string|null, url:string|null, url_label:string|null, poster_key:string|null, poster_alt:string|null}} MonthEvent
         * @typedef {{key:string, label:string}} MonthOption
         * @typedef {{ok:boolean, monthKey:string, monthLabel:string, prevMonthKey:(string|null), nextMonthKey:(string|null), monthEvents: MonthEvent[], months?: MonthOption[]}} MonthApiResponse
         */

        const initialEl = document.getElementById("eventsInitialState");
        const initial = JSON.parse((initialEl?.textContent || "{}").trim());

        let state = {
            monthKey: initial.monthKey,
            prevMonthKey: initial.prevMonthKey ?? null,
            nextMonthKey: initial.nextMonthKey ?? null,
        };

        const prevBtn = document.getElementById("eventsPrevBtn");
        const nextBtn = document.getElementById("eventsNextBtn");
        const monthSelect = document.getElementById("eventsMonthSelect");
        const elMonthLabel = document.getElementById("eventsMonthLabel");
        const elHint = document.getElementById("eventsMonthHint");
        const elStatus = document.getElementById("eventsAjaxStatus");
        const elGrid = document.getElementById("eventsCalendarGrid");
        // OPTIONAL (may not exist when monthEvents.length === 0)
        const elListWrap = document.getElementById("eventsMonthListWrap");
        const elList = document.getElementById("eventsMonthList");

        if (
            !(prevBtn instanceof HTMLButtonElement) ||
            !(nextBtn instanceof HTMLButtonElement) ||
            !(monthSelect instanceof HTMLSelectElement) ||
            !(elMonthLabel instanceof HTMLElement) ||
            !(elHint instanceof HTMLElement) ||
            !(elStatus instanceof HTMLElement) ||
            !(elGrid instanceof HTMLElement)
        ) {
            console.warn("[events] missing DOM hooks; ajax month switch disabled");
        } else {
            const dow = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

            function setNavDisabled(prevKey, nextKey) {
                if (prevBtn instanceof HTMLButtonElement) {
                    prevBtn.disabled = !prevKey;
                    prevBtn.style.opacity = prevBtn.disabled ? ".5" : "";
                    prevBtn.style.pointerEvents = prevBtn.disabled ? "none" : "";
                    prevBtn.dataset.targetMonth = prevKey || "";
                }
                if (nextBtn instanceof HTMLButtonElement) {
                    nextBtn.disabled = !nextKey;
                    nextBtn.style.opacity = nextBtn.disabled ? ".5" : "";
                    nextBtn.style.pointerEvents = nextBtn.disabled ? "none" : "";
                    nextBtn.dataset.targetMonth = nextKey || "";
                }
            }

            // Initialize nav target months for first render
            setNavDisabled(state.prevMonthKey, state.nextMonthKey);
            let isProgrammaticHash = false;

            function safeHref(raw) {
                try {
                    if (!raw) return null;
                    const u = new URL(raw, window.location.origin);
                    if (u.protocol === "http:" || u.protocol === "https:") return u.toString();
                    return null;
                } catch {
                    return null;
                }
            }

            function openDetailsById(id) {
                const el = document.getElementById(id);
                if (!(el instanceof HTMLDetailsElement)) return;

                el.open = true;
                // Scroll to it (smooth is fine, but "auto" is less janky on mobile)
                el.scrollIntoView({ block: "start", behavior: "auto" });

                // Focus the details itself (NOT the summary, since summary toggles)
                el.tabIndex = -1;
                el.focus({ preventScroll: true });
            }

            function handleHashOpen() {
                if (isProgrammaticHash) {
                    isProgrammaticHash = false;
                    // still open it (we want the behavior), but avoid double-trigger patterns
                    requestAnimationFrame(() => {
                        const hash = (window.location.hash || "").slice(1);
                        if (hash) openDetailsById(hash);
                    });
                    return;
                }
                const hash = (window.location.hash || "").slice(1);
                if (!hash) return;
                openDetailsById(hash);
            }

            // Open on direct load and when hash changes
            window.addEventListener("hashchange", handleHashOpen);
            handleHashOpen();

            function buildHint(count) {
                if (count === 0) return "No published events this month yet.";
                if (count === 1) return "1 published event this month.";
                return `${count} published events this month.`;
            }

            async function loadMonth(targetMonthKey, pushUrl = true) {
                if (!/^\d{4}-\d{2}$/.test(targetMonthKey)) return;

                elStatus.textContent = "Loading…";

                const res = await fetch(`/api/events/month?month=${encodeURIComponent(targetMonthKey)}`, {
                    headers: {accept: "application/json"},
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data?.ok) {
                    elStatus.textContent = "Could not load this month. Please try again.";
                    return;
                }

                state = {
                    monthKey: data.monthKey,
                    prevMonthKey: data.prevMonthKey ?? null,
                    nextMonthKey: data.nextMonthKey ?? null,
                };

                if (elMonthLabel instanceof HTMLElement) elMonthLabel.textContent = data.monthLabel ?? state.monthKey;
                if (elHint instanceof HTMLElement) elHint.textContent = buildHint((data.monthEvents ?? []).length);

                if (monthSelect instanceof HTMLSelectElement) {
                    monthSelect.value = state.monthKey;
                    // optional: if API sends months list, rebuild options here
                    if (Array.isArray(data.months)) {
                        monthSelect.replaceChildren();
                        for (const m of data.months) {
                            const opt = document.createElement("option");
                            opt.value = m.key;
                            opt.textContent = m.label ?? m.key;
                            monthSelect.appendChild(opt);
                        }
                        monthSelect.value = state.monthKey;
                    }
                }

                setNavDisabled(state.prevMonthKey, state.nextMonthKey);

                const monthEvents = data.monthEvents ?? [];
                buildCalendarGrid(state.monthKey, monthEvents);
                buildMonthList(monthEvents);

                if (pushUrl) {
                    const u = new URL(window.location.href);
                    u.searchParams.set("month", state.monthKey);
                    window.history.replaceState({}, "", u.pathname + u.search + u.hash);
                }

                elStatus.textContent = "";
            }

            if (prevBtn instanceof HTMLButtonElement) {
                prevBtn.addEventListener("click", () => {
                    const target = prevBtn.dataset.targetMonth || state.prevMonthKey;
                    if (target) loadMonth(target, true);
                });
            }
            if (nextBtn instanceof HTMLButtonElement) {
                nextBtn.addEventListener("click", () => {
                    const target = nextBtn.dataset.targetMonth || state.nextMonthKey;
                    if (target) loadMonth(target, true);
                });
            }

            if (monthSelect instanceof HTMLSelectElement) {
                monthSelect.addEventListener("change", () => {
                    const target = monthSelect.value;
                    if (target) loadMonth(target, true);
                });
            }

            window.addEventListener("popstate", () => {
                    const u = new URL(window.location.href);
                    const mk = (u.searchParams.get("month") ?? "").trim();
                    if (/^\d{4}-\d{2}$/.test(mk)) loadMonth(mk, false);
            });

            function fmtChicagoISODate(dateStr) {
                // returns YYYY-MM-DD in America/Chicago, for bucketing and display
                const d = new Date(dateStr);
                if (Number.isNaN(d.getTime())) return null;
                return new Intl.DateTimeFormat("en-CA", {
                    timeZone: tz,
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                }).format(d);
            }

            function fmtNiceTime(dateStr) {
                const d = new Date(dateStr);
                if (Number.isNaN(d.getTime())) return null;
                const raw = new Intl.DateTimeFormat("en-US", {
                    timeZone: tz,
                    hour: "numeric",
                    minute: "2-digit",
                }).format(d);
                return raw.replace(":00", "");
            }

            function fmtNiceDate(dateStr) {
                const d = new Date(dateStr);
                if (Number.isNaN(d.getTime())) return "Date TBD";
                return new Intl.DateTimeFormat("en-US", {
                    timeZone: tz,
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                }).format(d);
            }

            function monthKeyToDateParts(monthKey) {
                const [y, m] = monthKey.split("-").map(Number);
                return {y, m}; // m: 1-12
            }

            function buildCalendarGrid(monthKey, monthEvents) {
                // Clear and rebuild header + blanks + days
                elGrid.replaceChildren();

                // DOW header
                for (const d of dow) {
                    const div = document.createElement("div");
                    div.className = "dow";
                    div.setAttribute("role", "columnheader");
                    div.textContent = d;
                    elGrid.appendChild(div);
                }

                const {y, m} = monthKeyToDateParts(monthKey);
                const first = new Date(Date.UTC(y, m - 1, 1, 12));

                // compute startDow using a Chicago-local date rendered as day index by shifting with formatter.
                // create a Date at noon local Chicago by using UTC noon and format weekday, then map to index.
                const wk = new Intl.DateTimeFormat("en-US", {timeZone: tz, weekday: "short"}).format(first);
                const dowIndex = {Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6}[wk] ?? 0;

                const daysInMonth = new Date(Date.UTC(y, m, 0, 12)).getUTCDate();

                // Bucket month events by day
                /** @type {Map<string, MonthEvent[]>} */
                const byDay = new Map();

                for (const ev of monthEvents) {
                    if (!ev?.date_start) continue;
                    const key = fmtChicagoISODate(ev.date_start); // YYYY-MM-DD
                    if (!key) continue;
                    const arr = byDay.get(key) ?? [];
                    arr.push(ev);
                    byDay.set(key, arr);
                }

                // blanks
                for (let i = 0; i < dowIndex; i++) {
                    const blank = document.createElement("div");
                    blank.className = "cell blank";
                    blank.setAttribute("aria-hidden", "true");
                    elGrid.appendChild(blank);
                }

                // days
                for (let day = 1; day <= daysInMonth; day++) {
                    const iso = `${monthKey}-${String(day).padStart(2, "0")}`;
                    const dayEvents = byDay.get(iso) ?? [];

                    const cell = document.createElement("div");
                    cell.className = "cell";
                    cell.setAttribute("role", "gridcell");

                    const num = document.createElement("div");
                    num.className = "dayNum";
                    num.textContent = String(day);
                    cell.appendChild(num);

                    if (dayEvents.length) {
                        const chips = document.createElement("div");
                        chips.className = "chips";

                        dayEvents.slice(0, 3).forEach((/** @type {MonthEvent} */ ev) => {
                            const a = document.createElement("a");
                            a.className = "chip";
                            const targetId = `event-${ev.id}`;
                            a.href = `#${targetId}`;
                            a.setAttribute("title", ev.summary ?? ev.title ?? "");
                            a.setAttribute("aria-disabled", "false");

                            // Open immediately on click (so it opens even if browser doesn’t fire hashchange for same-hash clicks)
                            a.addEventListener("click", (e) => {
                                e.preventDefault();

                                const nextHash = `#${targetId}`;
                                if (window.location.hash !== nextHash) {
                                    isProgrammaticHash = true;
                                    window.location.hash = targetId;
                                } else {
                                    // Same hash: hashchange won't fire, so open directly
                                    openDetailsById(targetId);
                                }
                            });

                            const kind = document.createElement("span");
                            kind.className = "chipKind";
                            kind.textContent = ev.kind ?? "";

                            const title = document.createElement("span");
                            title.className = "chipTitle";
                            title.textContent = ev.title ?? "";

                            a.appendChild(kind);
                            a.appendChild(title);
                            chips.appendChild(a);
                        });

                        if (dayEvents.length > 3) {
                            const more = document.createElement("div");
                            more.className = "muted small";
                            more.textContent = `+${dayEvents.length - 3} more`;
                            chips.appendChild(more);
                        }

                        cell.appendChild(chips);
                    } else {
                        const empty = document.createElement("div");
                        empty.className = "muted empty";
                        empty.textContent = "—";
                        cell.appendChild(empty);
                    }

                    elGrid.appendChild(cell);
                }
            }

            function buildMonthList(monthEvents) {
                // Month list is optional (not rendered when there are no events)
                if (!(elListWrap instanceof HTMLElement) || !(elList instanceof HTMLElement)) return;

                elList.replaceChildren();
                if (!monthEvents.length) {
                    elListWrap.style.display = "none";
                    return;
                }
                elListWrap.style.display = "";

                for (const e of monthEvents) {
                    const details = document.createElement("details");
                    details.className = "panel item eventDetails";
                    details.id = `event-${e.id}`;

                    const summary = document.createElement("summary");
                    summary.className = "eventSummary";

                    const meta = document.createElement("div");
                    meta.className = "meta";

                    const title = document.createElement("div");
                    title.className = "title";
                    title.textContent = e.title ?? "";

                    const sub = document.createElement("div");
                    sub.className = "sub";
                    const nice = e.date_start ? fmtNiceDate(e.date_start) : "Date TBD";
                    const time = e.date_start ? fmtNiceTime(e.date_start) : null;
                    sub.textContent = `${nice}${time ? ` • ${time}` : ""}${e.location ? ` • ${e.location}` : ""}`;

                    meta.appendChild(title);
                    meta.appendChild(sub);

                    const pill = document.createElement("span");
                    pill.className = "pillMini";
                    pill.textContent = e.kind ?? "";

                    summary.appendChild(meta);
                    summary.appendChild(pill);

                    const body = document.createElement("div");
                    body.className = "eventBody";

                    if (e.summary) {
                        const p = document.createElement("p");
                        p.className = "summary";
                        p.textContent = e.summary;
                        body.appendChild(p);
                    }

                    if (e.poster_key) {
                        const fig = document.createElement("figure");
                        fig.className = "poster";
                        const img = document.createElement("img");
                        img.loading = "lazy";
                        img.src = `/api/events/poster?id=${encodeURIComponent(e.id)}`;
                        img.alt = e.poster_alt ?? e.title ?? "Event poster";
                        fig.appendChild(img);
                        body.appendChild(fig);
                    }

                    const href = safeHref(e.url);

                    if (href) {
                        const p = document.createElement("p");
                        p.style.margin = ".75rem 0 0";

                        const a = document.createElement("a");
                        a.className = "pill";
                        a.href = href;
                        a.target = "_blank";
                        a.rel = "noopener noreferrer";
                        a.textContent = e.url_label ?? "Details";

                        p.appendChild(a);
                        body.appendChild(p);
                    }

                    details.appendChild(summary);
                    details.appendChild(body);
                    elList.appendChild(details);
                }
            }
        }
    </script>

    <style  is:global>
        .pad { margin-top: var(--section-gap); }
        .lead { margin: 0 0 1.25rem; max-width: 75ch; }
        .calendarPanel { padding: 1.25rem; background: var(--panel-bg-dense); border-color: rgba(255,255,255,0.14); }
        .calHead { display:flex; align-items: flex-end; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        .calHint { font-size: .95rem; display: flex;align-items: center;gap: .6rem;flex-wrap: wrap;}
        .calNav { display:flex; align-items: center; position: relative; gap: .75rem; }
        .calNav .monthSelect {
            width: auto;
            max-width: 14.5rem;
            min-width: 10rem;
            padding: .5rem 1rem;
            border-radius: 999px;
            border: 1px solid var(--border-strong);
            background: var(--glass-dark);
            color: var(--text-on-glass);
            font-weight: 700;
            line-height: 1;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: .5rem;
            margin-top: 1rem;
        }

        .dow {
            color: var(--text-soft);
            font-weight: 800;
            font-size: .85rem;
            padding: .5rem .5rem;
            border-bottom: 1px solid var(--border-strong);
        }

        .cell {
            border: 1px solid rgba(255,255,255,0.14);
            border-radius: 12px;
            padding: .65rem;
            background: rgba(0,0,0,0.22);
            min-height: 110px;
            backdrop-filter: blur(2px);
            display: grid;
            gap: .5rem;
            align-content: start;
            overflow: hidden;
        }

        .blank { background: transparent; border: 1px dashed rgba(255,255,255,0.08); }
        .dayNum {
            font-weight: 900;
            font-size: .95rem;
            color: rgba(255,255,255,0.95);
            text-shadow: var(--text-shadow);
        }

        .chips { display: grid; gap: .35rem; min-width: 0; }
        .chip {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: .5rem;
            align-items: baseline;
            padding: .45rem .55rem;
            border-radius: 12px;
            border: 1px solid var(--border-strong);
            background: var(--glass-dark);
            color: var(--text-on-glass);
            text-decoration: none;
            min-width: 0;
            overflow: hidden;
        }
        .chip[aria-disabled="true"] { opacity: .65; pointer-events: none; }
        .chipKind { font-weight: 900; font-size: .72rem; letter-spacing: .02em; opacity: .9; }
        .chipTitle {
            font-weight: 700;
            font-size: .85rem;
            line-height: 1.2;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .empty { opacity: .45; }
        .eventDetails { padding: 0; }
        .eventSummary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            padding: 1.1rem;
        }
        .eventSummary::-webkit-details-marker { display: none; }
        .eventBody { padding: 0 1.1rem 1.1rem; }
        .eventDetails[open] .eventSummary {
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }

        .poster { margin: .85rem 0 0; }
        .poster img {
            width: 100%;
            height: auto;
            border-radius: 14px;
            border: 1px solid var(--border-strong);
            box-shadow: var(--card-shadow-soft);
            background: var(--glass-dark);
        }
        .monthList { margin-top: 1.25rem; }
        .list { display: grid; gap: 1rem; }
        .item { padding: 1.1rem; }
        .title { font-weight: 900; color: var(--text); font-size: 1.1rem; }
        .sub { color: var(--text-soft); font-size: 0.95rem; margin-top: 0.35rem; }
        .summary { margin: 0.75rem 0 0; color: var(--text-soft); max-width: 80ch; }
        .pillMini{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding: .18rem .55rem;
            border-radius: 999px;
            border: 1px solid var(--border-strong);
            background: var(--glass-dark-strong);
            color: var(--text-on-glass);
            font-weight: 800;
            font-size: .78rem;
            margin-right: .35rem;
        }
        .thisMonthBtn{ padding: .3rem .65rem;font-size: .85rem; }
        .calNav .pill[aria-disabled="true"]{
            opacity: .55;
            pointer-events: none;
            cursor: default;
        }

        @media (max-width: 760px){
            .calendar { gap: .4rem; }
            /* Hide calendar grid on phones; keep month list */
            .calendarWrap { display: none; }
            .calNav .monthSelect { display: none; }
            .dow { display:none; }
            .cell { min-height: 92px; padding: .55rem; }
            .chipTitle { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        }

        @media (max-width: 580px){
            .calendarPanel { padding: 1rem; }
            .item { padding: 1rem; }
            .calNav{
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: .5rem;
                width: 100%;
            }
            .calNav .pill{
                width: 100%;
                justify-content: center;
            }
       }
    </style>
</BaseLayout>
