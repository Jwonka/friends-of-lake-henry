---
import BaseLayout from "../layouts/BaseLayout.astro";
import type { D1Database } from "@cloudflare/workers-types";
export const prerender = false;

type EventRow = {
    id: string;
    title: string;
    kind: string;
    status: string;
    date_start: string | null;
    date_end: string | null;
    is_tbd: number;
    location: string | null;
    summary: string | null;
    url: string | null;
    url_label: string | null;
    poster_key: string | null;
    poster_alt: string | null;
};

const env = (Astro.locals as any).runtime?.env as { DB?: D1Database } | undefined;
const DB = env?.DB;
if (!DB) throw new Error("DB binding missing (Astro.locals.runtime.env.DB).");

function parseMonthParam(raw: string | null) {
    // Accept: YYYY-MM
    if (!raw) return null;
    const m = raw.match(/^(\d{4})-(\d{2})$/);
    if (!m) return null;
    const year = Number(m[1]);
    const month = Number(m[2]); // 1-12
    if (!Number.isFinite(year) || !Number.isFinite(month) || month < 1 || month > 12) return null;
    return { year, monthIndex: month - 1 };
}

function monthKey(year: number, monthIndex: number) {
    return `${year}-${String(monthIndex + 1).padStart(2, "0")}`;
}

function monthLabel(d: Date) {
    return d.toLocaleString("en-US", { month: "long", year: "numeric" });
}

function toISODate(d: Date) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
}

function safeDate(dateStr: string | null) {
    if (!dateStr) return null;
    const d = new Date(dateStr); // works for YYYY-MM-DD and YYYY-MM-DDTHH:mm
    return Number.isNaN(d.getTime()) ? null : d;
}

const url = new URL(Astro.request.url);
const m = parseMonthParam(url.searchParams.get("month"));

const now = new Date();
const year = m?.year ?? now.getFullYear();
const monthIndex = m?.monthIndex ?? now.getMonth();

const firstOfMonth = new Date(year, monthIndex, 1);
const nextMonth = new Date(year, monthIndex + 1, 1);

const monthStartISO = `${monthKey(year, monthIndex)}-01`;             // YYYY-MM-01
const nextMonthStartISO = `${monthKey(nextMonth.getFullYear(), nextMonth.getMonth())}-01`;

const prev = new Date(year, monthIndex - 1, 1);
const next = new Date(year, monthIndex + 1, 1);

const prevHref = `/events?month=${monthKey(prev.getFullYear(), prev.getMonth())}`;
const nextHref = `/events?month=${monthKey(next.getFullYear(), next.getMonth())}`;
const thisHref = `/events?month=${monthKey(now.getFullYear(), now.getMonth())}`;

const dow = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
const startDow = firstOfMonth.getDay(); // 0=Sun
const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();

// Query: month events (published, not TBD, within month)
const monthRes = await DB.prepare(`
  SELECT id, title, kind, status, date_start, date_end, is_tbd,
         location, summary, url, url_label, poster_key, poster_alt
  FROM events
  WHERE status = 'published'
    AND is_tbd = 0
    AND date_start IS NOT NULL
    AND date_start >= ?
    AND date_start < ?
  ORDER BY date_start ASC, title ASC
`).bind(monthStartISO, nextMonthStartISO).all<EventRow>();

const monthEvents = monthRes.results ?? [];

// Query: TBD events (published + is_tbd OR missing date_start)
const tbdRes = await DB.prepare(`
  SELECT id, title, kind, status, date_start, date_end, is_tbd,
         location, summary, url, url_label, poster_key, poster_alt
  FROM events
  WHERE status = 'published'
    AND (is_tbd = 1 OR date_start IS NULL OR date_start = '')
  ORDER BY updated_at DESC, title ASC
`).all<EventRow>();

const tbdEvents = tbdRes.results ?? [];

// Bucket month events by day
const byDay = new Map<string, EventRow[]>();
for (const e of monthEvents) {
    const d = safeDate(e.date_start);
    if (!d) continue;
    const key = toISODate(d);
    const arr = byDay.get(key) ?? [];
    arr.push(e);
    byDay.set(key, arr);
}
---

<BaseLayout title="Events | Friends of Lake Henry">
    <div class="container">
        <section class="card pad enter-block">
            <h1>Events</h1>
            <p class="lead">
                Upcoming events, raffles, and community opportunities to support Lake Henry.
            </p>

            <div class="panel calendarPanel enter-block delay-1" aria-label="Events calendar">
                <div class="calHead">
                    <div>
                        <h2 class="h2-zero">{monthLabel(firstOfMonth)}</h2>
                        <div class="muted calHint">
                            {monthEvents.length === 0
                                ? "No published events this month yet."
                                : monthEvents.length === 1
                                    ? "1 published event this month."
                                    : `${monthEvents.length} published events this month.`}

                            <a class="pill thisMonthBtn" href={thisHref} aria-label="Current month">This month</a>
                        </div>
                    </div>

                    <div class="calNav">
                        <a class="pill" href={prevHref} aria-label="Previous month">← Prev</a>
                        <a class="pill" href={nextHref} aria-label="Next month">Next →</a>
                    </div>
                </div>

                <div class="calendarWrap" aria-hidden="false">
                    <div class="calendar" role="grid" aria-label={`Calendar for ${monthLabel(firstOfMonth)}`}>
                        {dow.map((d) => (
                                <div class="dow" role="columnheader">{d}</div>
                        ))}

                        {Array.from({ length: startDow }).map(() => (
                                <div class="cell blank" aria-hidden="true"></div>
                        ))}

                        {Array.from({ length: daysInMonth }).map((_, idx) => {
                            const day = idx + 1;
                            const iso = `${monthKey(year, monthIndex)}-${String(day).padStart(2, "0")}`;
                            const dayEvents = byDay.get(iso) ?? [];
                            return (
                                <div class="cell" role="gridcell">
                                    <div class="dayNum">{day}</div>

                                    {dayEvents.length ? (
                                        <div class="chips">
                                            {dayEvents.slice(0, 3).map((ev) => (
                                                <a
                                                    class="chip"
                                                    href={ev.url ?? "#"}
                                                    aria-disabled={ev.url ? "false" : "true"}
                                                    title={ev.summary ?? ev.title}
                                                    target={ev.url ? "_blank" : undefined}
                                                    rel={ev.url ? "noopener noreferrer" : undefined}
                                                >
                                                    <span class="chipKind">{ev.kind}</span>
                                                    <span class="chipTitle">{ev.title}</span>
                                                </a>
                                            ))}
                                            {dayEvents.length > 3 ? (
                                                <div class="muted small">+{dayEvents.length - 3} more</div>
                                            ) : null}
                                        </div>
                                    ) : (
                                        <div class="muted empty">—</div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>

                {/* Month list (good for readability + mobile + SEO) */}
                {monthEvents.length > 0 && (
                    <div class="monthList">
                        <div class="list">
                            {monthEvents.map((e) => {
                                const d = safeDate(e.date_start);
                                const nice = d
                                    ? d.toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" })
                                    : "Date TBD";

                                const time = d
                                    ? d.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" }).replace(":00", "")
                                    : null;

                                return (
                                    <details class="panel item eventDetails">
                                        <summary class="eventSummary">
                                            <div class="meta">
                                                <div class="title">{e.title}</div>
                                                <div class="sub">
                                                    {nice}{time ? ` • ${time}` : ""}
                                                    {e.location ? <span> • {e.location}</span> : null}
                                                </div>
                                            </div>
                                            <span class="pillMini">{e.kind}</span>
                                        </summary>

                                        <div class="eventBody">
                                            {e.summary ? <p class="summary">{e.summary}</p> : null}

                                            {/* Poster (later: wire poster_key to an image endpoint) */}
                                            {e.poster_key ? (
                                                <figure class="poster">
                                                    <img src={`/api/events/poster?id=${e.id}`} alt={e.poster_alt ?? e.title} loading="lazy" />
                                                </figure>
                                            ) : null}

                                            {e.url ? (
                                                <p style="margin: .75rem 0 0;">
                                                    <a class="pill" href={e.url} target="_blank" rel="noopener noreferrer">
                                                        {e.url_label ?? "Details"}
                                                    </a>
                                                </p>
                                            ) : null}
                                        </div>
                                    </details>
                                );
                            })}
                        </div>
                    </div>
                )}
            </div>

            {/* TBD */}
            <div class="panel enter-block delay-2" style="margin-top: var(--section-gap);">
                <h2 class="h2-zero">To be announced</h2>
                <p class="muted" style="margin: .35rem 0 1rem;">
                    {tbdEvents.length === 0
                        ? "No TBD events right now."
                        : tbdEvents.length === 1
                            ? "1 event doesn’t have a confirmed date yet."
                            : `${tbdEvents.length} events don’t have a confirmed date yet.`}
                </p>

                {tbdEvents.length > 0 && (
                    <div class="list">
                        {tbdEvents.map((e) => (
                            <article class="panel item">
                                <div class="meta">
                                    <div class="title">{e.title}</div>
                                    <div class="sub">
                                        <span class="pillMini">TBD</span>
                                        {e.location ? <span> • {e.location}</span> : null}
                                    </div>
                                </div>
                                {e.summary ? <p class="summary">{e.summary}</p> : null}
                                {e.url ? (
                                        <p style="margin: .75rem 0 0;">
                                            <a class="pill" href={e.url}>{e.url_label ?? "Details"}</a>
                                        </p>
                                ) : null}
                            </article>
                        ))}
                    </div>
                )}
            </div>
        </section>
    </div>

    <style>
        .pad { margin-top: var(--section-gap); }
        .lead { margin: 0 0 1.25rem; max-width: 75ch; }
        .calendarPanel { padding: 1.25rem; background: var(--panel-bg-dense); border-color: rgba(255,255,255,0.14); }
        .calHead { display:flex; align-items: flex-end; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        .calHint { font-size: .95rem; display: flex;align-items: center;gap: .6rem;flex-wrap: wrap;}
        .calNav { display:flex; gap: .5rem; flex-wrap: wrap; }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: .5rem;
            margin-top: 1rem;
        }

        .dow {
            color: var(--text-soft);
            font-weight: 800;
            font-size: .85rem;
            padding: .5rem .5rem;
            border-bottom: 1px solid var(--border-strong);
        }

        .cell {
            border: 1px solid rgba(255,255,255,0.14);
            border-radius: 12px;
            padding: .65rem;
            background: rgba(0,0,0,0.22);
            min-height: 110px;
            backdrop-filter: blur(2px);
            display: grid;
            gap: .5rem;
            align-content: start;
            overflow: hidden;
        }

        .blank { background: transparent; border: 1px dashed rgba(255,255,255,0.08); }
        .dayNum {
            font-weight: 900;
            font-size: .95rem;
            color: rgba(255,255,255,0.95);
            text-shadow: var(--text-shadow);
        }

        .chips { display: grid; gap: .35rem; min-width: 0; }
        .chip {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: .5rem;
            align-items: baseline;
            padding: .45rem .55rem;
            border-radius: 12px;
            border: 1px solid var(--border-strong);
            background: var(--glass-dark);
            color: var(--text-on-glass);
            text-decoration: none;
            min-width: 0;
            overflow: hidden;
        }
        .chip[aria-disabled="true"] { opacity: .65; pointer-events: none; }
        .chipKind { font-weight: 900; font-size: .72rem; letter-spacing: .02em; opacity: .9; }
        .chipTitle {
            font-weight: 700;
            font-size: .85rem;
            line-height: 1.2;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .empty { opacity: .45; }
        .eventDetails { padding: 0; }
        .eventSummary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            padding: 1.1rem;
        }
        .eventSummary::-webkit-details-marker { display: none; }
        .eventBody { padding: 0 1.1rem 1.1rem; }
        .eventDetails[open] .eventSummary {
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }

        .poster { margin: .85rem 0 0; }
        .poster img {
            width: 100%;
            height: auto;
            border-radius: 14px;
            border: 1px solid var(--border-strong);
            box-shadow: var(--card-shadow-soft);
            background: var(--glass-dark);
        }
        .monthList { margin-top: 1.25rem; }
        .list { display: grid; gap: 1rem; }
        .item { padding: 1.1rem; }
        .title { font-weight: 900; color: var(--text); font-size: 1.1rem; }
        .sub { color: var(--text-soft); font-size: 0.95rem; margin-top: 0.35rem; }
        .summary { margin: 0.75rem 0 0; color: var(--text-soft); max-width: 80ch; }
        .pillMini{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding: .18rem .55rem;
            border-radius: 999px;
            border: 1px solid var(--border-strong);
            background: var(--glass-dark-strong);
            color: var(--text-on-glass);
            font-weight: 800;
            font-size: .78rem;
            margin-right: .35rem;
        }
        .thisMonthBtn{ padding: .3rem .65rem;font-size: .85rem; }
        @media (max-width: 760px){
            .calendar { gap: .4rem; }
            /* Hide calendar grid on phones; keep month list */
            .calendarWrap { display: none; }
            .thisMonthBtn { display:none; }
            .dow { display:none; }
            .cell { min-height: 92px; padding: .55rem; }
            .chipTitle { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        }

        @media (max-width: 520px){
            .calendarPanel { padding: 1rem; }
            .item { padding: 1rem; }
            .calNav{
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: .5rem;
                width: 100%;
            }
            .calNav .pill{
                width: 100%;
                justify-content: center;
            }
       }
    </style>
</BaseLayout>
