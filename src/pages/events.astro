---
import BaseLayout from "../layouts/BaseLayout.astro";
import type { D1Database } from "@cloudflare/workers-types";
export const prerender = false;

type EventRow = {
    id: string;
    title: string;
    kind: string;
    status: string;
    date_start: string | null;
    date_end: string | null;
    is_tbd: number;
    location: string | null;
    summary: string | null;
    url: string | null;
    url_label: string | null;
    poster_key: string | null;
    poster_alt: string | null;
};

const env = (Astro.locals as any).runtime?.env as { DB?: D1Database } | undefined;
const DB = env?.DB;
if (!DB) throw new Error("DB binding missing (Astro.locals.runtime.env.DB).");

const TZ = "America/Chicago";

function monthLabelFromKey(monthKey: string) {
    const [y, m] = monthKey.split("-").map(Number);
    const d = new Date(Date.UTC(y, m - 1, 15, 12)); // mid-month, noon UTC avoids DST edges
    return new Intl.DateTimeFormat("en-US", {
        timeZone: TZ,
        month: "long",
        year: "numeric",
    }).format(d);
}

function fmtNiceDateSSR(dateStr: string | null) {
    if (!dateStr) return "Date TBD";
    const d = new Date(dateStr);
    if (Number.isNaN(d.getTime())) return "Date TBD";
    return new Intl.DateTimeFormat("en-US", {
        timeZone: TZ,
        weekday: "short",
        month: "short",
        day: "numeric",
    }).format(d);
}

function fmtNiceTimeSSR(dateStr: string | null) {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    if (Number.isNaN(d.getTime())) return null;
    return new Intl.DateTimeFormat("en-US", {
        timeZone: TZ,
        hour: "numeric",
        minute: "2-digit",
    }).format(d).replace(":00", "");
}

function monthKey(year: number, monthIndex: number) {
    return `${year}-${String(monthIndex + 1).padStart(2, "0")}`;
}

function monthLabel(d: Date) {
    return d.toLocaleString("en-US", { month: "long", year: "numeric" });
}

function safeDate(dateStr: string | null) {
    if (!dateStr) return null;
    const d = new Date(dateStr); // works for YYYY-MM-DD and YYYY-MM-DDTHH:mm
    return Number.isNaN(d.getTime()) ? null : d;
}

function dayKeyChicagoFromDateStart(dateStr: string | null) {
    if (!dateStr) return null;
    const m = dateStr.match(/^(\d{4}-\d{2}-\d{2})/);
    return m ? m[1] : null;
}

function isMonthKey(s: string) {
    return /^\d{4}-\d{2}$/.test(s);
}

function chicagoCurrentMonthKey(d = new Date()) {
    return new Intl.DateTimeFormat("en-CA", {
        timeZone: "America/Chicago",
        year: "numeric",
        month: "2-digit",
    }).format(d).slice(0, 7);
}

const url = new URL(Astro.request.url);
const monthParamRaw = (url.searchParams.get("month") ?? "").trim();

const currentMonthKey = chicagoCurrentMonthKey(new Date());

// 1) Build allowed months from DB (data months) + current month
const monthsRes = await DB.prepare(`
  SELECT DISTINCT substr(date_start, 1, 7) AS monthKey
  FROM events
  WHERE status = 'published'
    AND is_tbd = 0
    AND date_start IS NOT NULL
    AND date_start != ''
  ORDER BY monthKey DESC
`).all();

const dbMonths = (monthsRes.results ?? [])
    .map((r: any) => String(r.monthKey ?? "").trim())
    .filter(isMonthKey);

const months = Array.from(new Set([currentMonthKey, ...dbMonths]))
    .sort((a, b) => b.localeCompare(a)); // DESC

const activeMonths = dbMonths.slice().sort((a, b) => b.localeCompare(a)); // DESC
const defaultMonthKey = activeMonths[0] ?? currentMonthKey;

// 2) Choose SSR month (clamp to allowed)
let ssrMonthKey = defaultMonthKey;
if (isMonthKey(monthParamRaw) && months.includes(monthParamRaw)) {
    ssrMonthKey = monthParamRaw;
}
if (!months.includes(ssrMonthKey)) ssrMonthKey = months[0] ?? currentMonthKey;

// 3) Prev/Next restricted to allowed months
const idx = months.indexOf(ssrMonthKey);
const prevMonthKey = idx >= 0 && idx + 1 < months.length ? months[idx + 1] : null;
const nextMonthKey = idx > 0 ? months[idx - 1] : null;

const prevHref = prevMonthKey ? `/events?month=${prevMonthKey}` : "/events";
const nextHref = nextMonthKey ? `/events?month=${nextMonthKey}` : "/events";
const thisHref = `/events?month=${currentMonthKey}`;

// 4) Use ssrMonthKey for calendar math + queries
const [yearStr, monthStr] = ssrMonthKey.split("-");
const year = Number(yearStr);
const monthIndex = Number(monthStr) - 1;

const firstOfMonth = new Date(year, monthIndex, 1);
const nextMonth = new Date(year, monthIndex + 1, 1);

const monthStartISO = `${ssrMonthKey}-01`;
const nextMonthStartISO = `${monthKey(nextMonth.getFullYear(), nextMonth.getMonth())}-01`;

const dow = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
const startDow = firstOfMonth.getDay();
const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();

// Query: month events (published, not TBD, within month)
const monthRes = await DB.prepare(`
  SELECT id, title, kind, status, date_start, date_end, is_tbd,
         location, summary, url, url_label, poster_key, poster_alt
  FROM events
  WHERE status = 'published'
    AND is_tbd = 0
    AND date_start IS NOT NULL
    AND date_start != ''
    AND date_start >= ?
    AND date_start < ?
  ORDER BY date_start ASC, title ASC
`).bind(monthStartISO, nextMonthStartISO).all<EventRow>();

const monthEvents = monthRes.results ?? [];

// Query: TBD events (published + is_tbd OR missing date_start)
const tbdRes = await DB.prepare(`
  SELECT id, title, kind, status, date_start, date_end, is_tbd,
         location, summary, url, url_label, poster_key, poster_alt
  FROM events
  WHERE status = 'published'
    AND (is_tbd = 1 OR date_start IS NULL OR date_start = '')
  ORDER BY updated_at DESC, title ASC
`).all<EventRow>();

const tbdEvents = tbdRes.results ?? [];

// Bucket month events by day
const byDay = new Map<string, EventRow[]>();
for (const e of monthEvents) {
    const key = dayKeyChicagoFromDateStart(e.date_start);
    if (!key) continue;
    const arr = byDay.get(key) ?? [];
    arr.push(e);
    byDay.set(key, arr);
}
---

<BaseLayout title="Events | Friends of Lake Henry">
    <div class="container">
        <section class="card pad enter-block">
            <h1>Events</h1>
            <p class="lead">
                Upcoming events, raffles, and community opportunities to support Lake Henry.
            </p>

            <div class="panel calendarPanel enter-block delay-1" aria-label="Events calendar">
                <div class="calHead">
                    <div>
                        <h2 class="h2-zero" id="eventsMonthLabel">{monthLabelFromKey(ssrMonthKey)}</h2>
                        <div class="muted calHint" id="eventsMonthHint">
                            {monthEvents.length === 0
                                ? "No published events this month yet."
                                : monthEvents.length === 1
                                    ? "1 published event this month."
                                    : `${monthEvents.length} published events this month.`}
                        </div>
                    </div>
                    <div class="calNav">
                        <a class="pill" id="eventsPrevBtn" href={prevMonthKey ? prevHref : "#"} aria-disabled={prevMonthKey ? "false" : "true"}>← Prev</a>

                        <label class="srOnly" for="eventsMonthSelect">Select month</label>
                        <select id="eventsMonthSelect" class="monthSelect">
                            {months.map((m) => (
                                    <option value={m} selected={m === ssrMonthKey}>{monthLabelFromKey(m)}</option>
                            ))}
                        </select>

                        <a class="pill" id="eventsNextBtn" href={nextMonthKey ? nextHref : "#"} aria-disabled={nextMonthKey ? "false" : "true"}>Next →</a>
                    </div>
                </div>
                <p id="eventsAjaxStatus" class="muted small" aria-live="polite" style="margin: .75rem 0 0;"></p>
                <div class="calendarWrap" aria-hidden="false">
                    <div class="calendar" id="eventsCalendarGrid" role="grid" aria-label={`Calendar for ${monthLabelFromKey(ssrMonthKey)}`}>
                        {dow.map((d) => (
                                <div class="dow" role="columnheader">{d}</div>
                        ))}

                        {Array.from({ length: startDow }).map(() => (
                                <div class="cell blank" aria-hidden="true"></div>
                        ))}

                        {Array.from({ length: daysInMonth }).map((_, idx) => {
                            const day = idx + 1;
                            const iso = `${monthKey(year, monthIndex)}-${String(day).padStart(2, "0")}`;
                            const dayEvents = byDay.get(iso) ?? [];
                            return (
                                <div class="cell" role="gridcell">
                                    <div class="dayNum">{day}</div>

                                    {dayEvents.length ? (
                                        <div class="chips">
                                            {dayEvents.slice(0, 3).map((ev) => (
                                                <a
                                                    class="chip"
                                                    href={ev.url ?? "#"}
                                                    aria-disabled={ev.url ? "false" : "true"}
                                                    title={ev.summary ?? ev.title}
                                                    target={ev.url ? "_blank" : undefined}
                                                    rel={ev.url ? "noopener noreferrer" : undefined}
                                                >
                                                    <span class="chipKind">{ev.kind}</span>
                                                    <span class="chipTitle">{ev.title}</span>
                                                </a>
                                            ))}
                                            {dayEvents.length > 3 ? (
                                                <div class="muted small">+{dayEvents.length - 3} more</div>
                                            ) : null}
                                        </div>
                                    ) : (
                                        <div class="muted empty">—</div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>

                {/* Month list (good for readability + mobile + SEO) */}
                {monthEvents.length > 0 && (
                    <div class="monthList" id="eventsMonthListWrap">
                        <div class="list" id="eventsMonthList">
                            {monthEvents.map((e) => {
                                const nice = fmtNiceDateSSR(e.date_start);
                                const time = fmtNiceTimeSSR(e.date_start);

                                return (
                                    <details class="panel item eventDetails">
                                        <summary class="eventSummary">
                                            <div class="meta">
                                                <div class="title">{e.title}</div>
                                                <div class="sub">
                                                    {nice}{time ? ` • ${time}` : ""}
                                                    {e.location ? <span> • {e.location}</span> : null}
                                                </div>
                                            </div>
                                            <span class="pillMini">{e.kind}</span>
                                        </summary>

                                        <div class="eventBody">
                                            {e.summary ? <p class="summary">{e.summary}</p> : null}

                                            {/* Poster (later: wire poster_key to an image endpoint) */}
                                            {e.poster_key ? (
                                                <figure class="poster">
                                                    <img src={`/api/events/poster?id=${e.id}`} alt={e.poster_alt ?? e.title} loading="lazy" />
                                                </figure>
                                            ) : null}

                                            {e.url ? (
                                                <p style="margin: .75rem 0 0;">
                                                    <a class="pill" href={e.url} target="_blank" rel="noopener noreferrer">
                                                        {e.url_label ?? "Details"}
                                                    </a>
                                                </p>
                                            ) : null}
                                        </div>
                                    </details>
                                );
                            })}
                        </div>
                    </div>
                )}
            </div>

            {/* TBD */}
            <div class="panel enter-block delay-2" style="margin-top: var(--section-gap);">
                <h2 class="h2-zero">To be announced</h2>
                <p class="muted" style="margin: .35rem 0 1rem;">
                    {tbdEvents.length === 0
                        ? "No TBD events right now."
                        : tbdEvents.length === 1
                            ? "1 event doesn’t have a confirmed date yet."
                            : `${tbdEvents.length} events don’t have a confirmed date yet.`}
                </p>

                {tbdEvents.length > 0 && (
                    <div class="list">
                        {tbdEvents.map((e) => (
                            <article class="panel item">
                                <div class="meta">
                                    <div class="title">{e.title}</div>
                                    <div class="sub">
                                        <span class="pillMini">TBD</span>
                                        {e.location ? <span> • {e.location}</span> : null}
                                    </div>
                                </div>
                                {e.summary ? <p class="summary">{e.summary}</p> : null}
                                {e.url ? (
                                        <p style="margin: .75rem 0 0;">
                                            <a class="pill" href={e.url}>{e.url_label ?? "Details"}</a>
                                        </p>
                                ) : null}
                            </article>
                        ))}
                    </div>
                )}
            </div>
        </section>
    </div>
    <script type="module">
        const tz = "America/Chicago";

        /**
         * @typedef {{id:string, title:string, kind:string, date_start:string|null, location:string|null, summary:string|null, url:string|null, url_label:string|null, poster_key:string|null, poster_alt:string|null}} MonthEvent
         * @typedef {{key:string, label:string}} MonthOption
         * @typedef {{ok:boolean, monthKey:string, monthLabel:string, prevMonthKey:(string|null), nextMonthKey:(string|null), monthEvents: MonthEvent[], months?: MonthOption[]}} MonthApiResponse
         */


        const elMonthLabel = document.getElementById("eventsMonthLabel");
        const elHint = document.getElementById("eventsMonthHint");
        const elPrev = document.getElementById("eventsPrevBtn");
        const elNext = document.getElementById("eventsNextBtn");
        const elSelect = document.getElementById("eventsMonthSelect");
        const elGrid = document.getElementById("eventsCalendarGrid");
        const elListWrap = document.getElementById("eventsMonthListWrap");
        const elList = document.getElementById("eventsMonthList");
        const elStatus = document.getElementById("eventsAjaxStatus");

        if (!(elPrev instanceof HTMLAnchorElement) ||
            !(elNext instanceof HTMLAnchorElement) ||
            !(elSelect instanceof HTMLSelectElement) ||
            !(elGrid instanceof HTMLElement) ||
            !(elListWrap instanceof HTMLElement) ||
            !(elList instanceof HTMLElement) ||
            !(elMonthLabel instanceof HTMLElement) ||
            !(elHint instanceof HTMLElement) ||
            !(elStatus instanceof HTMLElement)
        ) {
            // If markup changes, fail safely (SSR links still work).
            console.warn("[events] missing DOM hooks; ajax month switch disabled");
        } else {
            const dow = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

            function isMonthKey(s) {
                return /^\d{4}-\d{2}$/.test(s);
            }

            function monthKeyToDateParts(monthKey) {
                const [y, m] = monthKey.split("-").map(Number);
                return { y, m }; // m: 1-12
            }

            function fmtChicagoISODate(dateStr) {
                // returns YYYY-MM-DD in America/Chicago, for bucketing and display
                const d = new Date(dateStr);
                if (Number.isNaN(d.getTime())) return null;
                return new Intl.DateTimeFormat("en-CA", {
                    timeZone: tz,
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                }).format(d);
            }

            function fmtNiceDate(dateStr) {
                const d = new Date(dateStr);
                if (Number.isNaN(d.getTime())) return "Date TBD";
                return new Intl.DateTimeFormat("en-US", {
                    timeZone: tz,
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                }).format(d);
            }

            function fmtNiceTime(dateStr) {
                const d = new Date(dateStr);
                if (Number.isNaN(d.getTime())) return null;
                const raw = new Intl.DateTimeFormat("en-US", {
                    timeZone: tz,
                    hour: "numeric",
                    minute: "2-digit",
                }).format(d);
                return raw.replace(":00", "");
            }

            function setNavLink(a, monthKey) {
                if (!monthKey) {
                    a.setAttribute("aria-disabled", "true");
                    a.style.pointerEvents = "none";
                    a.style.opacity = "0.55";
                    // keep href as-is for no-JS fallback?  blank it to avoid confusion
                    a.setAttribute("data-month", "");
                    return;
                }
                a.setAttribute("aria-disabled", "false");
                a.style.pointerEvents = "";
                a.style.opacity = "";
                a.href = `/events?month=${monthKey}`;
                a.setAttribute("data-month", monthKey);
            }

            function syncSelectValue(monthKey) {
                if (!elSelect) return;
                elSelect.value = monthKey;
            }

            function rebuildSelectOptions(months, selectedKey) {
                if (!elSelect || !Array.isArray(months)) return;

                // months is [{key,label}, ...] from the API
                elSelect.innerHTML = "";
                for (const m of months) {
                    const opt = document.createElement("option");
                    opt.value = m.key;
                    opt.textContent = m.label ?? m.key;
                    if (m.key === selectedKey) opt.selected = true;
                    elSelect.appendChild(opt);
                }
            }

            function buildHint(count) {
                if (count === 0) return "No published events this month yet.";
                if (count === 1) return "1 published event this month.";
                return `${count} published events this month.`;
            }

            function buildCalendarGrid(monthKey, monthEvents) {
                // Clear and rebuild header + blanks + days
                elGrid.innerHTML = "";

                // DOW header
                for (const d of dow) {
                    const div = document.createElement("div");
                    div.className = "dow";
                    div.setAttribute("role", "columnheader");
                    div.textContent = d;
                    elGrid.appendChild(div);
                }

                const { y, m } = monthKeyToDateParts(monthKey);
                const first = new Date(Date.UTC(y, m - 1, 1, 12));

                // compute startDow using a Chicago-local date rendered as day index by shifting with formatter.
                // create a Date at noon local Chicago by using UTC noon and format weekday, then map to index.
                const wk = new Intl.DateTimeFormat("en-US", { timeZone: tz, weekday: "short" }).format(first);
                const dowIndex = { Sun:0, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6 }[wk] ?? 0;

                const daysInMonth = new Date(Date.UTC(y, m, 0, 12)).getUTCDate();

                // Bucket month events by day
                /** @type {Map<string, MonthEvent[]>} */
                const byDay = new Map();

                for (const ev of monthEvents) {
                    if (!ev?.date_start) continue;
                    const key = fmtChicagoISODate(ev.date_start); // YYYY-MM-DD
                    if (!key) continue;
                    const arr = byDay.get(key) ?? [];
                    arr.push(ev);
                    byDay.set(key, arr);
                }

                // blanks
                for (let i = 0; i < dowIndex; i++) {
                    const blank = document.createElement("div");
                    blank.className = "cell blank";
                    blank.setAttribute("aria-hidden", "true");
                    elGrid.appendChild(blank);
                }

                // days
                for (let day = 1; day <= daysInMonth; day++) {
                    const iso = `${monthKey}-${String(day).padStart(2, "0")}`;
                    const dayEvents = byDay.get(iso) ?? [];

                    const cell = document.createElement("div");
                    cell.className = "cell";
                    cell.setAttribute("role", "gridcell");

                    const num = document.createElement("div");
                    num.className = "dayNum";
                    num.textContent = String(day);
                    cell.appendChild(num);

                    if (dayEvents.length) {
                        const chips = document.createElement("div");
                        chips.className = "chips";

                        dayEvents.slice(0, 3).forEach((/** @type {MonthEvent} */ ev) => {
                            const a = document.createElement("a");
                            a.className = "chip";
                            a.href = ev.url ?? "#";
                            a.setAttribute("title", ev.summary ?? ev.title ?? "");
                            if (!ev.url) {
                                a.setAttribute("aria-disabled", "true");
                            } else {
                                a.setAttribute("aria-disabled", "false");
                                a.target = "_blank";
                                a.rel = "noopener noreferrer";
                            }

                            const kind = document.createElement("span");
                            kind.className = "chipKind";
                            kind.textContent = ev.kind ?? "";

                            const title = document.createElement("span");
                            title.className = "chipTitle";
                            title.textContent = ev.title ?? "";

                            a.appendChild(kind);
                            a.appendChild(title);
                            chips.appendChild(a);
                        });

                        if (dayEvents.length > 3) {
                            const more = document.createElement("div");
                            more.className = "muted small";
                            more.textContent = `+${dayEvents.length - 3} more`;
                            chips.appendChild(more);
                        }

                        cell.appendChild(chips);
                    } else {
                        const empty = document.createElement("div");
                        empty.className = "muted empty";
                        empty.textContent = "—";
                        cell.appendChild(empty);
                    }

                    elGrid.appendChild(cell);
                }
            }

            function buildMonthList(monthEvents) {
                elList.innerHTML = "";
                if (!monthEvents.length) {
                    elListWrap.style.display = "none";
                    return;
                }
                elListWrap.style.display = "";

                for (const e of monthEvents) {
                    const details = document.createElement("details");
                    details.className = "panel item eventDetails";

                    const summary = document.createElement("summary");
                    summary.className = "eventSummary";

                    const meta = document.createElement("div");
                    meta.className = "meta";

                    const title = document.createElement("div");
                    title.className = "title";
                    title.textContent = e.title ?? "";

                    const sub = document.createElement("div");
                    sub.className = "sub";
                    const nice = e.date_start ? fmtNiceDate(e.date_start) : "Date TBD";
                    const time = e.date_start ? fmtNiceTime(e.date_start) : null;
                    sub.textContent = `${nice}${time ? ` • ${time}` : ""}${e.location ? ` • ${e.location}` : ""}`;

                    meta.appendChild(title);
                    meta.appendChild(sub);

                    const pill = document.createElement("span");
                    pill.className = "pillMini";
                    pill.textContent = e.kind ?? "";

                    summary.appendChild(meta);
                    summary.appendChild(pill);

                    const body = document.createElement("div");
                    body.className = "eventBody";

                    if (e.summary) {
                        const p = document.createElement("p");
                        p.className = "summary";
                        p.textContent = e.summary;
                        body.appendChild(p);
                    }

                    if (e.poster_key) {
                        const fig = document.createElement("figure");
                        fig.className = "poster";
                        const img = document.createElement("img");
                        img.loading = "lazy";
                        img.src = `/api/events/poster?id=${encodeURIComponent(e.id)}`;
                        img.alt = e.poster_alt ?? e.title ?? "Event poster";
                        fig.appendChild(img);
                        body.appendChild(fig);
                    }

                    if (e.url) {
                        const p = document.createElement("p");
                        p.style.margin = ".75rem 0 0";
                        const a = document.createElement("a");
                        a.className = "pill";
                        a.href = e.url;
                        a.target = "_blank";
                        a.rel = "noopener noreferrer";
                        a.textContent = e.url_label ?? "Details";
                        p.appendChild(a);
                        body.appendChild(p);
                    }

                    details.appendChild(summary);
                    details.appendChild(body);
                    elList.appendChild(details);
                }
            }

            let inflight = null;

            async function loadMonth(monthKey, { push = true } = {}) {
                if (!isMonthKey(monthKey)) return;

                // cancel prior request (best-effort)
                if (inflight?.abort) inflight.abort();
                const ac = new AbortController();
                inflight = ac;

                elStatus.textContent = "Loading…";

                const res = await fetch(`/api/events/month?month=${encodeURIComponent(monthKey)}`, {
                    signal: ac.signal,
                    headers: { "accept": "application/json" },
                });

                if (!res.ok) {
                    elStatus.textContent = "Could not load this month. Please try again.";
                    return;
                }

                /** @type {MonthApiResponse} */
                const data = await res.json();
                if (!data?.ok) {
                    elStatus.textContent = "Could not load this month. Please try again.";
                    return;
                }

                // Update heading + hint text (keep This Month button)
                elMonthLabel.textContent = data.monthLabel ?? monthKey;

                const hintText = buildHint((data.monthEvents ?? []).length);
                // Keep existing This Month link node; just replace leading text safely.
                // Easiest: clear and rebuild hint container.
                elHint.innerHTML = "";
                elHint.append(document.createTextNode(hintText + " "));

                // restore This Month link (keeps CSS + mobile hiding rules)
                const nowKey = new Intl.DateTimeFormat("en-CA", { timeZone: tz, year:"numeric", month:"2-digit" })
                    .format(new Date()).slice(0, 7);

                // Update nav links + disabled state
                setNavLink(elPrev, data.prevMonthKey);
                setNavLink(elNext, data.nextMonthKey);

                // Update dropdown (include current month even if empty)
                if (data.months) {
                    rebuildSelectOptions(data.months, data.monthKey);
                } else {
                    // fallback: just sync selected value if API doesn't provide list
                    syncSelectValue(data.monthKey);
                }
                syncSelectValue(data.monthKey);

                // Rebuild grid + list
                const monthEvents = data.monthEvents ?? [];
                buildCalendarGrid(data.monthKey, monthEvents);
                buildMonthList(monthEvents);

                // URL + history
                if (push) {
                    const u = new URL(window.location.href);
                    u.searchParams.set("month", data.monthKey);
                    window.history.pushState({ month: data.monthKey }, "", u.pathname + u.search + u.hash);
                }

                elStatus.textContent = "";
            }

            function interceptNav(a) {
                a.addEventListener("click", (e) => {
                    // Always prevent default if link is disabled or has no target
                    const disabled = a.getAttribute("aria-disabled") === "true";
                    const mk =
                        a.getAttribute("data-month") ||
                        (a.href ? new URL(a.href).searchParams.get("month") : "") ||
                        "";

                    if (disabled || !isMonthKey(mk)) {
                        e.preventDefault();
                        return;
                    }

                    e.preventDefault();
                    loadMonth(mk, { push: true });
                });
            }

            // Initial wire-up: store month keys on the anchors so they disable/enable cleanly
            const initialPrev = new URL(elPrev.href, window.location.origin).searchParams.get("month");
            const initialNext = new URL(elNext.href, window.location.origin).searchParams.get("month");
            if (isMonthKey(initialPrev)) elPrev.setAttribute("data-month", initialPrev);
            if (isMonthKey(initialNext)) elNext.setAttribute("data-month", initialNext);

            interceptNav(elPrev);
            interceptNav(elNext);

            elSelect.addEventListener("change", () => {
                const mk = String(elSelect.value ?? "");
                if (!isMonthKey(mk)) return;
                loadMonth(mk, { push: true });
            });

            window.addEventListener("popstate", (e) => {
                const u = new URL(window.location.href);
                const mk = (u.searchParams.get("month") ?? "").trim();
                if (isMonthKey(mk)) loadMonth(mk, { push: false });
            });
        }
    </script>

    <style>
        .pad { margin-top: var(--section-gap); }
        .lead { margin: 0 0 1.25rem; max-width: 75ch; }
        .calendarPanel { padding: 1.25rem; background: var(--panel-bg-dense); border-color: rgba(255,255,255,0.14); }
        .calHead { display:flex; align-items: flex-end; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        .calHint { font-size: .95rem; display: flex;align-items: center;gap: .6rem;flex-wrap: wrap;}
        .calNav { display:flex; align-items: center; justify-content: center; gap: .5rem; flex-wrap: nowrap;; }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: .5rem;
            margin-top: 1rem;
        }

        .dow {
            color: var(--text-soft);
            font-weight: 800;
            font-size: .85rem;
            padding: .5rem .5rem;
            border-bottom: 1px solid var(--border-strong);
        }

        .cell {
            border: 1px solid rgba(255,255,255,0.14);
            border-radius: 12px;
            padding: .65rem;
            background: rgba(0,0,0,0.22);
            min-height: 110px;
            backdrop-filter: blur(2px);
            display: grid;
            gap: .5rem;
            align-content: start;
            overflow: hidden;
        }

        .blank { background: transparent; border: 1px dashed rgba(255,255,255,0.08); }
        .dayNum {
            font-weight: 900;
            font-size: .95rem;
            color: rgba(255,255,255,0.95);
            text-shadow: var(--text-shadow);
        }

        .chips { display: grid; gap: .35rem; min-width: 0; }
        .chip {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: .5rem;
            align-items: baseline;
            padding: .45rem .55rem;
            border-radius: 12px;
            border: 1px solid var(--border-strong);
            background: var(--glass-dark);
            color: var(--text-on-glass);
            text-decoration: none;
            min-width: 0;
            overflow: hidden;
        }
        .chip[aria-disabled="true"] { opacity: .65; pointer-events: none; }
        .chipKind { font-weight: 900; font-size: .72rem; letter-spacing: .02em; opacity: .9; }
        .chipTitle {
            font-weight: 700;
            font-size: .85rem;
            line-height: 1.2;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .empty { opacity: .45; }
        .eventDetails { padding: 0; }
        .eventSummary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            padding: 1.1rem;
        }
        .eventSummary::-webkit-details-marker { display: none; }
        .eventBody { padding: 0 1.1rem 1.1rem; }
        .eventDetails[open] .eventSummary {
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }

        .poster { margin: .85rem 0 0; }
        .poster img {
            width: 100%;
            height: auto;
            border-radius: 14px;
            border: 1px solid var(--border-strong);
            box-shadow: var(--card-shadow-soft);
            background: var(--glass-dark);
        }
        .monthList { margin-top: 1.25rem; }
        .list { display: grid; gap: 1rem; }
        .item { padding: 1.1rem; }
        .title { font-weight: 900; color: var(--text); font-size: 1.1rem; }
        .sub { color: var(--text-soft); font-size: 0.95rem; margin-top: 0.35rem; }
        .summary { margin: 0.75rem 0 0; color: var(--text-soft); max-width: 80ch; }
        .pillMini{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding: .18rem .55rem;
            border-radius: 999px;
            border: 1px solid var(--border-strong);
            background: var(--glass-dark-strong);
            color: var(--text-on-glass);
            font-weight: 800;
            font-size: .78rem;
            margin-right: .35rem;
        }
        .thisMonthBtn{ padding: .3rem .65rem;font-size: .85rem; }
        .calNav .pill[aria-disabled="true"]{
            opacity: .55;
            pointer-events: none;
            cursor: default;
        }

        .calNav .monthSelect{
            width: 220px;
            max-width: 260px;
        }

        @media (max-width: 760px){
            .calendar { gap: .4rem; }
            /* Hide calendar grid on phones; keep month list */
            .calendarWrap { display: none; }
            .calNav .monthSelect { display: none; }
            .dow { display:none; }
            .cell { min-height: 92px; padding: .55rem; }
            .chipTitle { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        }

        @media (max-width: 520px){
            .calendarPanel { padding: 1rem; }
            .item { padding: 1rem; }
            .calNav{
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: .5rem;
                width: 100%;
            }
            .calNav .pill{
                width: 100%;
                justify-content: center;
            }
       }
    </style>
</BaseLayout>
