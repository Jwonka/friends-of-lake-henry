---
export const prerender = false;
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { D1Database } from "@cloudflare/workers-types";

type PhotoRow = {
    id: string;
    category: string;
    title: string | null;
    caption: string | null;
    alt: string | null;
};


const env = (Astro.locals as any).runtime?.env as { DB?: D1Database } | undefined;
const DB = env?.DB;

let categories: string[] = ["All"];
let photos: PhotoRow[] = [];
let dbMissing = false;
let dbError: string | null = null;

if (!DB) {
    dbMissing = true;
    dbError = "DB binding missing";
} else {
    try {
        // Photos
        const res = await DB.prepare(`
            SELECT id, category, title, caption, alt
            FROM photos
            WHERE status = 'approved'
            ORDER BY approved_at DESC, submitted_at DESC
        `).all();

        photos = (res.results ?? []) as PhotoRow[];

        // Categories (DB is source of truth)
        const catRes = await DB.prepare(`
          SELECT DISTINCT category
          FROM photos
          WHERE status = 'approved'
          ORDER BY category
        `).all<{ category: string }>();

        categories = ["All", ...(catRes.results ?? []).map(r => r.category)];
    } catch (e) {
        dbError = e instanceof Error ? e.message : String(e);
    }
}
const submitted = Astro.url.searchParams.get("submitted");

let statusMsg = "";
let statusTone: "empty" | "success" | "error" = "empty";

if (submitted === "1") {
    statusMsg = "Thanks! Your photo was submitted for review.";
    statusTone = "success";
} else if (dbMissing) {
    statusMsg = "Server misconfigured: DB binding not available.";
    statusTone = "error";
} else if (dbError) {
    statusMsg = `Photos DB query failed: ${dbError}`;
    statusTone = "error";
}

const statusClass =
    statusTone === "success" ? "status--success" :
        statusTone === "error" ? "status--error" :
            "status--empty";
---

<BaseLayout title="Photos | Friends of Lake Henry">
    <div class="container" style="--maxw: 1400px;">
        <section class="card photosCard enter-block">
            <h1>Photos</h1>
            <p class="lead">
                Updates from restoration work, fundraising, community events, and life at Lake Henry.
            </p>
            <div
                id="status"
                class={`status ${statusClass}`}
                style="text-align:center;"
                role="status"
                aria-live="polite"
                aria-atomic="true"
                tabindex="-1"
            >
                {statusMsg}
            </div>
            <div class="filters enter-block delay-1" role="tablist" aria-label="Photo categories">
                <div class="tabs" role="tablist" aria-label="Photo categories">
                    {categories.map((cat, i) => (
                        <button
                            class={`pill filter ${i === 0 ? "active" : ""}`}
                            data-filter={cat}
                            role="tab"
                            id={`tab-${i}`}
                            aria-selected={i === 0 ? "true" : "false"}
                            tabindex={i === 0 ? 0 : -1}
                            type="button"
                        >
                            {cat}
                        </button>
                    ))}
                </div>
                <a class="pill submitPill" href="/photos/submit">Submit a photo</a>
            </div>
            <p id="filterStatus" class="srOnly" role="status" aria-live="polite" aria-atomic="true"></p>
            <div class="panel galleryPanel enter-block delay-2" role="tabpanel" aria-labelledby="tab-0">
                <div class="grid enter-block delay-2" id="photoGrid">
                    {photos.map((p) => (
                        <a class="photoLink" href={`/photos/${p.id}`} data-category={p.category}>
                            <figure class="photo">
                                <img src={`/api/photos/file?id=${p.id}`} alt={p.alt ?? ""} loading="lazy" />
                            </figure>
                        </a>
                    ))}
                </div>
            </div>
        </section>
    </div>
    <script type="module">
        import { initPhotoFilters } from "../../scripts/photos-filter";
        import { cleanFlashParams } from "../../scripts/clean-flash";

        initPhotoFilters();
        cleanFlashParams(["submitted"], 0);
    </script>
    <style>
        .photosCard{margin-top: var(--section-gap); padding: 1.5rem;}
        .lead { max-width: 75ch; margin: 0 0 1.25rem; color: var(--text-strong);line-height: 1.6;}

        /* 3-column layout: left spacer | centered tabs | right CTA */
        .filters{
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 0.6rem;
            margin: 2rem 0 1rem;
            padding: 0 var(--gallery-space);
        }

        /* keep the actual tabs centered as a unit */
        .filters .tabs{
            grid-column: 2;
            display: flex;
            justify-content: center;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        /* anchor submit to the right edge of the panel bounds */
        .filters .submitPill{
            grid-column: 3;
            justify-self: end;
            white-space: nowrap;
        }

        .filters .pill.filter{
            font: inherit;
            font-size: 1rem;
            font-weight: 600;
            -webkit-appearance: none;
            appearance: none;
            line-height: 1.2;
        }

        .filter.active{
            background: var(--brand-tint-strong);
            border-color: var(--border-bright-strong);
            color: var(--text-on-dark);
        }

        .galleryPanel{
            padding: 1.75rem var(--gallery-space);
            background: var(--panel-bg-dense);
            border-color: rgba(255,255,255,0.14);
        }

        .grid{
            display:grid;
            gap: var(--gallery-space);
            grid-template-columns: 1fr;
        }

        .photoLink { display: block; }

        .photo{
            position: relative;
            border-radius: 16px;
            overflow:hidden;
            padding: 0;
            background: var(--glass-dark);
            backdrop-filter: blur(6px);
            border: 1px solid var(--border-strong);
            box-shadow: var(--card-shadow-strong);
            transition: transform 140ms ease, box-shadow 160ms ease, border-color 160ms ease;
            aspect-ratio: 4 / 3;
        }

        .photo img{
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;

            /* “softness” at rest without blur-shimmer */
            filter: contrast(0.98) saturate(0.98);
            transform: translateZ(0);            /* reduces shimmer */
            will-change: filter, transform;
            transition: filter 160ms ease;
        }

        /* subtle darkening overlay at rest */
        .photo::after{
            content: "";
            position: absolute;
            inset: 0;
            background: var(--overlay-soft);
            opacity: 1;
            pointer-events: none;
            transition: opacity 160ms ease;
        }

        /* hover: brighten 3–5% + slight contrast, remove overlay */
        .photo:hover img{
            filter: brightness(1.04) contrast(1.05) saturate(1.02);
        }

        .photo:hover::after{
            opacity: 0;
        }
        /* Submit pill should share the SAME material as the filter pills */
        .filters .pill.submitPill{
            /* use the same base as tabs */
            background: var(--glass-dark);
            border-color: var(--border-strong);
            color: var(--text-on-dark);

            /* subtle green tint, same “glass” feel */
            box-shadow: var(--card-shadow-soft);
            position: relative;
            overflow: hidden;
        }

        /* green tint overlay (keeps the same glass underneath) */
        .filters .pill.submitPill::before{
            content:"";
            position:absolute;
            inset:0;
            background: rgba(34,197,94,0.22);
            pointer-events:none;
        }

        /* hover: slightly stronger tint only */
        .filters .pill.submitPill:hover::before,
        .filters .pill.submitPill:focus-visible::before{
            background: rgba(34,197,94,0.32);
        }
        /* Breakpoints */
        @media (min-width: 640px){
            .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        @media (min-width: 980px){
            .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

        /* Mid widths: submit drops to its own line and centers */
        @media (max-width: 1090px){
            .filters{
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
                row-gap: .6rem;
            }

            .filters .tabs{
                grid-column: 1;
                justify-content: center;
            }

            .filters .submitPill{
                grid-column: 1;
                justify-self: center; /* centered until mobile stack kicks in */
            }
        }

        /* Mobile: stack category pills, full-width for easy tapping */
        @media (max-width: 520px){
            /* Give the grid more room */
            .galleryPanel{
                padding: 1rem;
            }

            .photoLink{
                width: 100%;
                margin-bottom: 0.5rem;
            }

            /* Make photos taller and more immersive */
            .photo{
                aspect-ratio: 3 / 4;
                border-radius: 18px;
                width: 100%;
                margin: 0;
            }

            .photo img{
                object-fit: cover;
                width: 100%;
            }

            .filters{
                display: flex;
                flex-direction: column;
                align-items: stretch;
                gap: .5rem;
                margin: 1.25rem 0 1.25rem;
                padding: 0;
            }

            .filters .tabs{
                display: flex;
                flex-direction: column;
                gap: .5rem;
            }

            .filters .pill.filter,
            .filters .pill.submitPill{
                display: flex;
                width: 100%;
                justify-content: center;
                align-items: center;

                padding: .85rem 1rem;
                border-radius: 14px;

                background: var(--panel-bg-dense);
                backdrop-filter: none;
            }

            .filters .pill.submitPill{
                position: relative;
                overflow: hidden;
            }

            .filters .pill.submitPill::before{
                content:"";
                position:absolute;
                inset:0;
                background: rgba(34,197,94,0.18);
                pointer-events:none;
            }

            .filters .pill.submitPill:hover::before,
            .filters .pill.submitPill:focus-visible::before{
                background: rgba(34,197,94,0.28);
            }

        }
    </style>
</BaseLayout>
