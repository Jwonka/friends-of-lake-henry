---
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import type { D1Database } from "@cloudflare/workers-types";

type DonorRow = {
    id: number;
    name: string;
    amount_cents: number;
    display_name: string | null;
    in_memory_of: string | null;
};

const fmt = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" });

// Cloudflare adapter exposes bindings here:
const DB = (Astro.locals as any).runtime.env.DB as D1Database;

const listRes = await DB.prepare(`
    SELECT id, name, amount_cents, display_name, in_memory_of
    FROM donors
    ORDER BY amount_cents DESC, id DESC
`).all<DonorRow>();

const donors = listRes.results ?? [];

const totalRow = await DB.prepare(`
    SELECT COALESCE(SUM(amount_cents), 0) AS total_cents
    FROM donors
`).first<{ total_cents: number }>();

const totalCents = Number(totalRow?.total_cents ?? 0);
const totalDollars = totalCents / 100;
---
<BaseLayout title="Donors | Friends of Lake Henry">
    <div class="container">
        <section class="card pad enter-block">
            <h1>Donors</h1>
            <p class="lead">
                Friends of Lake Henry is grateful for everyone who contributes time, funding, and support.
            </p>

            <div class="summaryRow enter-block delay-1">
                <div class="pillStat">
                    <div class="statNum">{donors.length}</div>
                    <div class="statLbl">Donations listed</div>
                </div>
                <div class="pillStat">
                    <div class="statNum">{fmt.format(totalDollars)}</div>
                    <div class="statLbl">Total (from current list)</div>
                </div>
            </div>

            <div class="grid enter-block delay-2">
                {donors.map((d) => (
                        <article class="panel donor">
                            <div class="topRow">
                                <h2 class="name">{d.display_name ?? d.name}</h2>
                                <div class="amt">{fmt.format(d.amount_cents / 100)}</div>
                            </div>

                            {d.in_memory_of && (
                                <p class="muted imo">
                                    In memory of <span class="imoName">{d.in_memory_of}</span>
                                </p>
                            )}
                        </article>
                ))}
            </div>

            <p class="muted small">
                If youâ€™re a sponsor and want to be listed here, please contact us.
            </p>

            <div class="panel support enter-block delay-3">
                <h2>Support Lake Henry&apos;s restoration</h2>
                <p class="muted">
                    Donations fund restoration efforts, community outreach, and fundraising operations.
                </p>
                <div class="ctaRow">
                    <a class="btn" href="/donate">Donate</a>
                </div>
            </div>
        </section>
    </div>

    <style>
        .pad { margin-top: var(--section-gap); }
        .lead { max-width: 80ch; margin: 0 0 1.25rem; }
        .small { font-size: 0.95rem; }

        .summaryRow{
            display:flex;
            gap: .75rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .pillStat{
            border: 1px solid var(--border);
            background: var(--glass-dark);
            border-radius: 999px;
            padding: .55rem .95rem;
            backdrop-filter: blur(6px);
            display:flex;
            align-items: baseline;
            gap: .6rem;
        }
        .statNum{ font-weight: 900; }
        .statLbl{ color: var(--text-soft); font-weight: 600; font-size: .95rem; }

        .grid{
            display: grid;
            gap: 1rem;
            margin-top: 1.25rem;
        }

        .donor { padding: 1.15rem; }
        .topRow{
            display:flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 1rem;
        }
        .name{
            margin: 0;
            font-size: 1.15rem;
            line-height: 1.2;
        }
        .amt{
            font-weight: 900;
            white-space: nowrap;
        }
        .imo{ margin: .5rem 0 0; }
        .imoName{ font-weight: 800; }

        .support{ margin-top: 1.25rem; }
        .ctaRow { display:flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem; }

        @media (min-width: 720px){
            .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (min-width: 1024px){
            .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        @media (max-width: 520px){
            .ctaRow{ flex-direction: column; align-items: stretch; }
            .ctaRow .btn{ width: 100%; justify-content: center; }
            .topRow{ align-items: flex-start; }
            .amt{ font-size: 1.05rem; }
        }
    </style>
</BaseLayout>
