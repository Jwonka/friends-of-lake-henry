---
import BaseLayout from "../layouts/BaseLayout.astro";
import { raffleConfig } from "../data/raffle";
export const prerender = false;

const { monthName, year, monthIndex, ticketPrice, flyerMeta, rules, prizesByDay } = raffleConfig;

const prizeByDay = new Map<number, string>(prizesByDay.map((p) => [p.day, p.prize]));
const flyerTitle = `${monthName} ${year} — Calendar Raffle`;

function daysInMonth(y: number, m: number) {
    return new Date(y, m + 1, 0).getDate();
}
function startDow(y: number, m: number) {
    return new Date(y, m, 1).getDay(); // 0=Sun
}

const totalDays = daysInMonth(year, monthIndex);
const firstDow = startDow(year, monthIndex);
const dowLabels = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
const facebookPageUrl = "https://www.facebook.com/people/Friends-of-Lake-Henry/61552199315213/";
const facebookPageHref = encodeURIComponent(facebookPageUrl);

// Page Plugin embed. This is the most reliable embed for Pages/SSR.
// It will show the Page content; if a Live is running, it often appears prominently.
const facebookEmbedSrc =
    `https://www.facebook.com/plugins/page.php?` +
    `href=${facebookPageHref}` +
    `&tabs=timeline` +
    `&width=500` +
    `&height=700` +
    `&small_header=true` +
    `&adapt_container_width=true` +
    `&hide_cover=false` +
    `&show_facepile=false`;
---

<BaseLayout title={`Raffle | Friends of Lake Henry`}>
    <div class="container">
        <section class="card hero enter-block">
            <div class="heroLeft">
                <div class="kicker">{monthName} {year}</div>
                <h1>{flyerMeta.subtitle}</h1>
                <p class="lead">
                    ${ticketPrice}.00 per ticket • Drawing daily • Proceeds support Lake Henry restoration.
                </p>

                <div class="heroCtas">
                    <a class="btn" href="#" aria-disabled="true">Buy tickets (coming soon)</a>
                    <a class="btn" href="/events">View events</a>
                </div>

                <p class="fine">
                    Online ticket purchasing will be enabled once raffle rules and processing details are confirmed.
                </p>
            </div>

            <div class="heroRight">
                <div class="infoCard">
                    <div class="infoTitle">{flyerMeta.orgLine}</div>
                    <div class="muted">{flyerMeta.address}</div>
                    <div class="muted">Phone: {flyerMeta.phone}</div>
                    <div class="muted" style="margin-top:.5rem;">
                        Winners will be posted on our Facebook page.
                    </div>
                </div>
            </div>
        </section>

        <section class="card calendarCard enter-block delay-1">
            <h2 class="sectionTitle">{flyerTitle}</h2>

            <div class="calendar" role="grid" aria-label={`${monthName} ${year} raffle calendar`}>
                {dowLabels.map((d) => (
                        <div class="dow" role="columnheader">{d}</div>
                ))}

                {Array.from({ length: firstDow }).map(() => (
                        <div class="cell blank" aria-hidden="true"></div>
                ))}

                {Array.from({ length: totalDays }).map((_, idx) => {
                    const day = idx + 1;
                    const prize = prizeByDay.get(day);
                    return (
                            <div class="cell" role="gridcell">
                                <div class="dayNum">{day}</div>
                                <div class="prize">{prize ?? "Prize TBD"}</div>
                            </div>
                    );
                })}
            </div>
        </section>
        <section class="card liveCard enter-block delay-2">
            <h2 class="sectionTitle">Live Stream</h2>

            <div class="panel livePanel">
                <div class="liveFrame">
                    <iframe
                        class="fbFrame"
                        src={"https://www.facebook.com/reel/1393954152400350"}
                        title="Friends of Lake Henry — Facebook Live"
                        loading="lazy"
                        allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"
                        allowfullscreen
                    ></iframe>
                </div>

                <div class="liveFallback">
                    <p class="muted" style="margin:0 0 .75rem;">
                        Live is offline right now. When a broadcast starts, it will appear here (if embedding is allowed in your browser/network).
                    </p>

                    <a
                        class="btn fbBtn"
                        href={facebookPageUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                    >
                        Watch on Facebook
                    </a>
                </div>
            </div>
        </section>

        <section class="card rules  enter-block delay-3">
            <h2>Rules</h2>
            <ul>
                {rules.map((r) => <li>{r}</li>)}
            </ul>
        </section>
    </div>

    <style>
        .hero {
            margin-top: var(--section-gap);
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }
        .kicker { color: var(--muted); font-weight: 800; letter-spacing: .3px; }
        .lead { margin: 0; max-width: 70ch; }

        .heroCtas { display: flex; gap: .75rem; flex-wrap: wrap; margin-top: var(--section-gap); }
        .fine { margin: .75rem 0 0; color: var(--muted); font-size: .95rem; }

        .infoCard {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.25rem;
            background: rgba(0,0,0,0.28);
            backdrop-filter: blur(2px);
        }
        .infoTitle { font-weight: 900; margin-bottom: .25rem; }
        .muted { color: var(--muted); }

        .sectionTitle { margin: 0 0 1rem; font-size: 1.35rem; }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: .5rem;
        }
        .calendarCard{
            margin-top: var(--section-gap);
            padding: 1.5rem;
        }

        .dow {
            color: var(--muted);
            font-weight: 800;
            font-size: .85rem;
            padding: .5rem .5rem;
            border-bottom: 1px solid var(--border);
        }
        .cell{
            border: 1px solid rgba(255,255,255,0.14);
            border-radius: 12px;
            padding: .65rem .65rem .75rem;
            background: rgba(0,0,0,0.28);
            min-height: 86px;
            backdrop-filter: blur(2px);
        }

        .cell:hover{
            background: rgba(0,0,0,0.32);
            border-color: rgba(255,255,255,0.22);
        }

        .dayNum{
            font-weight: 900;
            font-size: .95rem;
            margin-bottom: .35rem;
            color: rgba(255,255,255,0.95);
            text-shadow: 0 1px 6px rgba(0,0,0,0.35);
        }

        .prize{
            color: rgba(255,255,255,0.86);
            font-size: .85rem;
            line-height: 1.25;
            text-shadow: 0 1px 6px rgba(0,0,0,0.35);
        }

        .blank {
            background: transparent;
            border: 1px dashed rgba(255,255,255,0.08);
        }

        .rules {
            margin-top: var(--section-gap);
            margin-bottom: calc(var(--section-gap) * 1.25);
            padding: 1.5rem 1.75rem;
            border-radius: 14px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
        }
        .rules ul { margin: 0; padding-left: 1.1rem; color: var(--muted); }
        .rules li { margin: 0.4rem 0;
            line-height: 1.5; }
        .liveCard{
            margin-top: var(--section-gap);
            padding: 1.5rem;
        }

        .livePanel{
            display: grid;
            gap: 1rem;
        }

        .liveFrame{
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: rgba(0,0,0,0.20);
        }

        .fbFrame{
            display: block;
            width: 100%;
            height: 700px;
            border: 0;
        }

        .liveFallback{
            display: flex;
            gap: .75rem;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        /* make the Facebook CTA feel intentional without changing global .btn */
        .fbBtn{
            border-color: rgba(24,119,242,0.35);
        }
        .fbBtn:hover,
        .fbBtn:focus-visible{
            border-color: rgba(24,119,242,0.55);
        }

        @media (min-width: 980px) {
            .hero { grid-template-columns: 1.35fr .65fr; align-items: start; }
        }
        @media (min-width: 760px) and (max-width: 979px) {
            .hero { grid-template-columns: 1fr; }
            .heroCtas { gap: .6rem; }
            .calendarCard { padding: 1.25rem; }
            .prize { font-size: .82rem; }
        }
        @media (max-width: 760px) {
            .calendarCard { padding: 1rem; }
            .calendar { gap: .4rem; }
            .dow { display: none; }
            /* reduce the iframe height */
            .fbFrame{ height: 560px; }
            .cell {
                min-height: 72px;
                padding: .55rem .55rem .65rem;
            }

            .dayNum { font-size: .9rem; margin-bottom: .25rem; }
            .prize  { font-size: .78rem; line-height: 1.2; }

            /* prevent long prize names from causing layout pain */
            .prize {
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
        }
        @media (max-width: 520px) {
            .heroCtas { flex-direction: column; align-items: stretch; }
            .heroCtas .btn { width: 100%; }
            .fbFrame{ height: 520px; }
            .liveFallback{
                flex-direction: column;
                align-items: stretch;
            }
            .liveFallback .btn{
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</BaseLayout>

