---
import BaseLayout from "../layouts/BaseLayout.astro";
export const prerender = false;

const facebookPageUrl =
    "https://www.facebook.com/people/Friends-of-Lake-Henry/61552199315213/";

const rules = [
    "Drawing at 6pm EVERYDAY in November.",
    "All proceeds go to Lake Henry Project.",
    "If drawn, name goes in for remaining drawings.",
    'Every firearm has a minimum value of $1000; $800 cash option if you do not choose the firearm.',
    "All State & Federal laws apply; MUST be 21 or older to purchase a ticket.",
];

type LiveConfig = { latestVideoUrl: string | null; updatedAt: string | null };

const env = Astro.locals.runtime.env;

let liveConfig: LiveConfig = { latestVideoUrl: null, updatedAt: null };

try {
    const raw = await env.CONFIG?.get("raffle_live");
    if (raw) {
        const parsed = JSON.parse(raw) as Partial<LiveConfig>;
        liveConfig = {
            latestVideoUrl: typeof parsed.latestVideoUrl === "string" ? parsed.latestVideoUrl : null,
            updatedAt: typeof parsed.updatedAt === "string" ? parsed.updatedAt : null,
        };
    }
} catch {
    // ignore bad KV / parse
}

const embedSrc = liveConfig.latestVideoUrl
    ? `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(liveConfig.latestVideoUrl)}&show_text=0&adapt_container_width=true`
    : `https://www.facebook.com/plugins/page.php?href=${encodeURIComponent(facebookPageUrl)}&tabs=timeline&small_header=true&adapt_container_width=true&hide_cover=false&show_facepile=false`;

const updatedAtDate = liveConfig.updatedAt ? new Date(liveConfig.updatedAt) : null;
const updatedAtLabel =
    updatedAtDate && Number.isFinite(updatedAtDate.getTime()) ? updatedAtDate.toLocaleString() : null;
---

<BaseLayout title={`Raffle | Friends of Lake Henry`}>
    <div class="container">
        <section class="card hero enter-block">
            <div class="heroLeft">
                <div class="kicker">Friends of Lake Henry</div>
                <h1>Raffle Winners & Live Drawings</h1>
                <p class="lead">
                    Watch drawings on Facebook Live and see winners from past raffles.
                </p>

                <div class="heroCtas">
                    <a class="btn" href="/events">View events</a>
                    <a class="btn" href={facebookPageUrl} target="_blank" rel="noopener noreferrer">Facebook page</a>
                </div>

                <p class="fine">
                    Ticket sales and raffle details will be posted when available.
                </p>
            </div>

            <div class="heroRight">
                <div class="infoCard">
                    <div class="infoTitle">Friends of Lake Henry</div>
                    <div class="muted">P.O. Box 142, Blair, WI 54616</div>
                    <div class="muted">Phone: 608-484-9241</div>
                    <div class="muted" style="margin-top:.5rem;">
                        Winners are posted on Facebook.
                    </div>
                </div>
            </div>
        </section>

        <section class="card liveCard enter-block delay-1">
            <h2 class="sectionTitle">Latest Live Stream</h2>

            <div class="panel livePanel">
                <div class="liveFrame">
                    <iframe
                        class="fbFrame"
                        src={embedSrc}
                        title="Friends of Lake Henry â€” Facebook Live"
                        loading="lazy"
                        allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"
                        allowfullscreen
                    ></iframe>
                </div>
                {updatedAtLabel && (
                    <p class="muted" style="margin:.5rem 0 0;">Last updated: {updatedAtLabel}</p>
                )}
                {!liveConfig.latestVideoUrl && (
                    <div class="liveFallback">
                        <p class="muted" style="margin:0 0 .75rem;">
                            Live is offline right now. When a broadcast starts, it will appear here (if embedding is allowed in your browser/network).
                        </p>
                        <a class="btn fbBtn" href={facebookPageUrl} target="_blank" rel="noopener noreferrer">
                            Watch on Facebook
                        </a>
                    </div>
                )}

                {liveConfig.latestVideoUrl && (
                    <div class="liveFallback">
                        <a class="btn fbBtn" href={facebookPageUrl} target="_blank" rel="noopener noreferrer">
                            Watch on Facebook
                        </a>
                    </div>
                )}
            </div>
        </section>

        <section class="card rules  enter-block delay-2">
            <h2>Rules</h2>
            <ul>
                {rules.map((r) => <li>{r}</li>)}
            </ul>
        </section>
    </div>

    <style>
        .hero {
            margin-top: var(--section-gap);
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }
        .kicker { color: var(--muted); font-weight: 800; letter-spacing: .3px; }
        .lead { margin: 0; max-width: 70ch; }

        .heroCtas { display: flex; gap: .75rem; flex-wrap: wrap; margin-top: var(--section-gap); }
        .fine { margin: .75rem 0 0; color: var(--muted); font-size: .95rem; }

        .infoCard {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.25rem;
            background: rgba(0,0,0,0.28);
            backdrop-filter: blur(2px);
        }
        .infoTitle { font-weight: 900; margin-bottom: .25rem; }
        .muted { color: var(--muted); }

        .sectionTitle { margin: 0 0 1rem; font-size: 1.35rem; }

        .blank {
            background: transparent;
            border: 1px dashed rgba(255,255,255,0.08);
        }

        .rules {
            margin-top: var(--section-gap);
            margin-bottom: calc(var(--section-gap) * 1.25);
            padding: 1.5rem 1.75rem;
            border-radius: 14px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
        }
        .rules ul { margin: 0; padding-left: 1.1rem; color: var(--muted); }
        .rules li { margin: 0.4rem 0;
            line-height: 1.5; }
        .liveCard{
            margin-top: var(--section-gap);
            padding: 1.5rem;
        }

        .livePanel{
            display: grid;
            gap: 1rem;
        }

        .liveFrame{
            aspect-ratio: 16 / 9;
            width: 100%;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: rgba(0,0,0,0.20);
        }

        .fbFrame{
            width: 100%;
            height: 100%;
            border: 0;
            display: block;
        }

        .liveFallback{
            display: flex;
            gap: .75rem;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        /* make the Facebook CTA feel intentional without changing global .btn */
        .fbBtn{
            border-color: rgba(24,119,242,0.35);
        }
        .fbBtn:hover,
        .fbBtn:focus-visible{
            border-color: rgba(24,119,242,0.55);
        }

        @media (min-width: 980px) {
            .hero { grid-template-columns: 1.35fr .65fr; align-items: start; }
        }
        @media (min-width: 760px) and (max-width: 979px) {
            .hero { grid-template-columns: 1fr; }
            .heroCtas { gap: .6rem; }
        }

        @media (max-width: 520px) {
            .heroCtas { flex-direction: column; align-items: stretch; }
            .heroCtas .btn { width: 100%; }
            .liveFallback{
                flex-direction: column;
                align-items: stretch;
            }
            .liveFallback .btn{
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</BaseLayout>

