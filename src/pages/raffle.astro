---
import type { D1Database } from "@cloudflare/workers-types";
import BaseLayout from "../layouts/BaseLayout.astro";
export const prerender = false;

const facebookPageReelsUrl =
    "https://www.facebook.com/61552199315213/reels/";

const facebookPageLiveUrl = "https://www.facebook.com/61552199315213/videos/";

const rules = [
    "Drawing at 6pm EVERYDAY in November.",
    "All proceeds go to Lake Henry Project.",
    "If drawn, name goes in for remaining drawings.",
    'Every firearm has a minimum value of $1000; $800 cash option if you do not choose the firearm.',
    "All State & Federal laws apply; MUST be 21 or older to purchase a ticket.",
];

type LiveConfig = { latestVideoUrl: string | null; previousVideoUrl?: string | null; updatedAt: string | null };
type WinnerRow = {
    id: string;
    drawDate: string;
    ticketNumber: number;
    name: string;
    town: string;
    prize: string | null;
};

const env = Astro.locals.runtime.env;
const DB = env.DB as D1Database | undefined;

function isMonthKey(s: string) {
    return /^\d{4}-\d{2}$/.test(s);
}

const url = new URL(Astro.request.url);

// Optional month selector: /raffle?month=2025-11
const monthParam = (url.searchParams.get("month") ?? "").trim();

// Default to current month (America/Chicago)
const now = new Date();
const currentMonth = new Intl.DateTimeFormat("en-CA", {
    timeZone: "America/Chicago",
    year: "numeric",
    month: "2-digit",
}).format(now).slice(0, 7); // YYYY-MM

let raffleKey = isMonthKey(monthParam) ? monthParam : currentMonth;

function monthKeyToLabel(monthKey: string) {
    const [y, m] = monthKey.split("-").map(Number);
    const d = new Date(Date.UTC(y, m - 1, 15, 12)); // 15th @ noon UTC = safe
    return new Intl.DateTimeFormat("en-US", {
        timeZone: "America/Chicago",
        month: "long",
        year: "numeric",
    }).format(d);
}

let months: string[] = [];
if (DB) {
    const monthsRes = await DB.prepare(
        `SELECT month_key as monthKey
       FROM raffle_months
      ORDER BY month_key DESC`
    ).all();

    months = (monthsRes.results ?? []).map((r: any) => String(r.monthKey));

    if (!months.length) {
        const derived = await DB.prepare(
            `SELECT DISTINCT raffle_key as monthKey
         FROM raffle_winners
        ORDER BY raffle_key DESC`
        ).all();
        months = (derived.results ?? []).map((r: any) => String(r.monthKey));
    }
}
months = Array.from(new Set([currentMonth, ...months])).sort((a, b) => b.localeCompare(a));
let defaultMonth = currentMonth;

// If DB is available, find latest month that has *something* (winners OR meta)
if (DB) {
    // Prefer months from raffle_months first (title set counts as “active”)
    const metaMonthsRes = await DB.prepare(
        `SELECT month_key as monthKey
     FROM raffle_months
     ORDER BY month_key DESC`
    ).all();
    const metaMonths = (metaMonthsRes.results ?? []).map((r: any) => String(r.monthKey));

    // Also consider months that have winners
    const winnerMonthsRes = await DB.prepare(
        `SELECT DISTINCT raffle_key as monthKey
     FROM raffle_winners
     ORDER BY raffle_key DESC`
    ).all();
    const winnerMonths = (winnerMonthsRes.results ?? []).map((r: any) => String(r.monthKey));

    const activeMonths = Array.from(new Set([...metaMonths, ...winnerMonths]))
        .sort((a, b) => b.localeCompare(a));

    // Default to the latest “active” month, but keep currentMonth in months list
    if (activeMonths.length) defaultMonth = activeMonths[0];
}

// If URL month is valid and exists in months => use it
// Else use defaultMonth (latest active, else current)
if (isMonthKey(monthParam) && months.includes(monthParam)) {
    raffleKey = monthParam;
} else {
    raffleKey = defaultMonth;
}

const idx = months.indexOf(raffleKey);
const prevMonthKey = idx >= 0 && idx + 1 < months.length ? months[idx + 1] : null; // because DESC
const nextMonthKey = idx > 0 ? months[idx - 1] : null;
const monthLabel = monthKeyToLabel(raffleKey);

let winners: WinnerRow[] = [];

if (DB) {
    const { results } = await DB.prepare(
        `SELECT id,
            draw_date as drawDate,
            ticket_number as ticketNumber,
            winner_name as name,
            town,
            prize
     FROM raffle_winners
     WHERE raffle_key = ?
     ORDER BY draw_date DESC, created_at DESC`
    ).bind(raffleKey).all();
    winners = (results ?? []) as any;
}

let raffleTitle: string | null = null;

if (DB) {
    const metaRes = await DB.prepare(
        `SELECT title FROM raffle_months WHERE month_key = ?`
    ).bind(raffleKey).first();

    raffleTitle = metaRes ? String((metaRes as any).title ?? "").trim() : "";
    if (!raffleTitle) raffleTitle = null;
}

let liveConfig: LiveConfig = { latestVideoUrl: null, previousVideoUrl: null,  updatedAt: null };

try {
    const raw = await env.CONFIG?.get("raffle_live");

    if (raw) {
        const parsed = JSON.parse(raw) as Partial<LiveConfig>;
        const cur = typeof parsed.latestVideoUrl === "string" ? parsed.latestVideoUrl.trim() : "";
        const prev = typeof parsed.previousVideoUrl === "string" ? parsed.previousVideoUrl.trim() : "";
        liveConfig = {
            latestVideoUrl: cur.length ? cur : null,
            previousVideoUrl: prev.length ? prev : null,
            updatedAt: typeof parsed.updatedAt === "string" ? parsed.updatedAt : null,
        };
    }
} catch {
    // ignore bad KV / parse
}
const initial = {
    monthKey: raffleKey,
    prevMonthKey,
    nextMonthKey,
};

const effectiveVideoUrl = liveConfig.latestVideoUrl ?? liveConfig.previousVideoUrl ?? null;

const embedSrc = effectiveVideoUrl
    ? `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(effectiveVideoUrl)}&show_text=0&adapt_container_width=true`
    : null;

const updatedAtDate = liveConfig.updatedAt ? new Date(liveConfig.updatedAt) : null;
const updatedAtLabel =
    updatedAtDate && Number.isFinite(updatedAtDate.getTime()) ? updatedAtDate.toLocaleString("en-US", { timeZone: "America/Chicago" }) : null;
---

<BaseLayout title={`Raffle | Friends of Lake Henry`}>
    <div class="container">
        <section class="card hero enter-block">
            <div class="heroLeft">
                <div class="kicker">Friends of Lake Henry</div>
                <h1>Raffle Winners & Live Drawings</h1>
                <p class="lead">
                    Watch drawings on Facebook Live and see winners from past raffles.
                </p>

                <div class="heroCtas">
                    <a class="btn btn--facebook enter-block delay-1" href={facebookPageLiveUrl} target="_blank" rel="noopener noreferrer">Live videos</a>
                    <a class="btn  btn--facebook enter-block delay-2" href={facebookPageReelsUrl} target="_blank" rel="noopener noreferrer">Winner reels</a>
                </div>

                <p class="fine">
                    Ticket sales and raffle details will be posted when available.
                </p>
            </div>

            <div class="heroRight">
                <div class="infoCard enter-block delay-3">
                    <div class="infoTitle">Friends of Lake Henry</div>
                    <div class="muted">P.O. Box 142, Blair, WI 54616</div>
                    <div class="muted">Phone: 608-484-9241</div>
                    <div class="muted" style="margin-top:.5rem;">
                        Winners are posted on Facebook.
                    </div>
                </div>
            </div>
        </section>

        <section class="card liveCard enter-block delay-3">
            <h2 class="sectionTitle">Latest Live Stream</h2>

            <div class="panel livePanel enter-block delay-4">
                {embedSrc ? (
                    <div class="liveFrame">
                        <iframe
                            class="fbFrame"
                            src={embedSrc}
                            title="Friends of Lake Henry — Facebook Live"
                            loading="lazy"
                            allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"
                            allowfullscreen
                        ></iframe>
                    </div>
                ) : (
                    <div class="liveFrame liveFrame--empty">
                        <div class="liveOverlay">
                            <p class="muted" style="margin:0 0 .75rem;">
                                Live is offline right now. Watch on Facebook for the newest broadcast.
                            </p>
                            <a class="btn  btn--facebook" href={facebookPageLiveUrl} target="_blank" rel="noopener noreferrer">
                                Watch on Facebook
                            </a>
                        </div>
                    </div>
                )}

                {updatedAtLabel && (
                    <p class="muted" style="margin:.5rem 0 0;">Last updated: {updatedAtLabel}</p>
                )}

                {embedSrc && (
                    <div class="liveFallback enter-block delay-5">
                        <a class="btn  btn--facebook" href={facebookPageLiveUrl} target="_blank" rel="noopener noreferrer">
                            Watch on Facebook
                        </a>
                    </div>
                )}
            </div>
        </section>

        <section class="card winnersCard enter-block delay-6">
            <h2 class="sectionTitle">Past Winners</h2>
            <nav class="monthNav" aria-label="Select raffle month">
                <button class="pill" type="button" data-month-nav="prev" aria-label="Previous month">
                    ← Prev
                </button>

                <div class="monthNavCenter" aria-live="polite">
                    <div class="monthNavLabel" id="monthLabel">{monthLabel}</div>
                    <div class="muted" id="raffleTitle" style={raffleTitle ? "" : "display:none"}>
                        {raffleTitle}
                    </div>
                </div>

                <button class="pill" type="button" data-month-nav="next" aria-label="Next month">
                    Next →
                </button>
            </nav>
            <div id="winnersPanel" class="panel winnersPanel">
                {winners.length ? (
                    <div class="winnersTableWrap" role="region" aria-label="Raffle winners list">
                        <table class="winnersTable enter-block delay-7" id="winnersTable">
                            <thead>
                            <tr>
                                <th scope="col">Date</th>
                                <th scope="col">Ticket</th>
                                <th scope="col">Name</th>
                                <th scope="col">Town</th>
                            </tr>
                            </thead>
                            <tbody>
                            {winners.map((w) => (
                                <tr>
                                    <td><time data-iso={w.drawDate}>{w.drawDate}</time></td>
                                    <td>{w.ticketNumber}</td>
                                    <td>{w.name}</td>
                                    <td>{w.town}</td>
                                </tr>
                            ))}
                            </tbody>
                        </table>
                    </div>
                ) : (
                    <p class="muted" id="winnersEmpty" style="margin:0;">
                        No winners posted for {monthLabel} yet.
                    </p>
                )}
            </div>
        </section>

        <section class="card rules  enter-block delay-8">
            <h2>Rules</h2>
            <ul>
                {rules.map((r) => <li>{r}</li>)}
            </ul>
        </section>
    </div>
    <script
        id="raffleInitialState"
        type="application/json"
        set:html={JSON.stringify(initial)}
    ></script>
    <script type="module">
        function formatDatesForMobile() {
            if (!window.matchMedia("(max-width: 520px)").matches) return;
            document.querySelectorAll('time[data-iso]').forEach((t) => {
                const iso = t.getAttribute("data-iso");
                const d = iso ? new Date(iso) : null;
                if (!d || Number.isNaN(d.getTime())) return;
                t.textContent = d.toLocaleDateString("en-US", { month: "numeric", day: "numeric" }); // M/D
            });
        }
        formatDatesForMobile();
        window.addEventListener("resize", formatDatesForMobile);
        
        const initialEl = document.getElementById("raffleInitialState");
        const initial = /** @type {{monthKey:string, prevMonthKey:string|null, nextMonthKey:string|null}} */ (
            JSON.parse((initialEl?.textContent || "{}").trim())
        );

        let state = { ...initial };

        const prevBtn = document.querySelector('button[data-month-nav="prev"]');
        const nextBtn = document.querySelector('button[data-month-nav="next"]');
        const monthLabelEl = document.getElementById("monthLabel");
        const raffleTitleEl = document.getElementById("raffleTitle");
        const winnersPanel = document.getElementById("winnersPanel");

        function setNavDisabled(prevMonthKey, nextMonthKey) {
            if (prevBtn instanceof HTMLButtonElement) {
                prevBtn.disabled = !prevMonthKey;
                prevBtn.style.opacity = prevBtn.disabled ? ".5" : "";
                prevBtn.style.pointerEvents = prevBtn.disabled ? "none" : "";
                prevBtn.dataset.targetMonth = prevMonthKey || "";
            }
            if (nextBtn instanceof HTMLButtonElement) {
                nextBtn.disabled = !nextMonthKey;
                nextBtn.style.opacity = nextBtn.disabled ? ".5" : "";
                nextBtn.style.pointerEvents = nextBtn.disabled ? "none" : "";
                nextBtn.dataset.targetMonth = nextMonthKey || "";
            }
        }

        function renderWinners(monthLabel, raffleTitle, winners) {
            if (!(winnersPanel instanceof HTMLElement)) return;

            if (monthLabelEl) monthLabelEl.textContent = monthLabel;

            if (raffleTitleEl instanceof HTMLElement) {
                if (raffleTitle) {
                    raffleTitleEl.textContent = raffleTitle;
                    raffleTitleEl.style.display = "";
                } else {
                    raffleTitleEl.textContent = "";
                    raffleTitleEl.style.display = "none";
                }
            }

            winnersPanel.innerHTML = "";

            if (Array.isArray(winners) && winners.length) {
                const wrap = document.createElement("div");
                wrap.className = "winnersTableWrap";
                wrap.setAttribute("role", "region");
                wrap.setAttribute("aria-label", "Raffle winners list");

                const table = document.createElement("table");
                table.className = "winnersTable";
                table.innerHTML = `
                    <thead>
                      <tr>
                        <th scope="col">Date</th>
                        <th scope="col">Ticket</th>
                        <th scope="col">Name</th>
                        <th scope="col">Town</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                `;

                const tbody = table.querySelector("tbody");
                for (const w of winners) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                      <td>${w.drawDate ?? ""}</td>
                      <td>${w.ticketNumber ?? ""}</td>
                      <td>${w.name ?? ""}</td>
                      <td>${w.town ?? ""}</td>
                    `;
                    tbody?.appendChild(tr);
                }

                wrap.appendChild(table);
                winnersPanel.appendChild(wrap);
            } else {
                const p = document.createElement("p");
                p.className = "muted";
                p.style.margin = "0";
                p.textContent = `No winners posted for ${monthLabel} yet.`;
                winnersPanel.appendChild(p);
            }
        }

        async function loadMonth(targetMonthKey, pushUrl = true) {
            const u = new URL("/api/raffle/month", window.location.origin);
            u.searchParams.set("month", targetMonthKey);

            const res = await fetch(u.toString(), { headers: { "Accept": "application/json" } });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || !data?.ok) throw new Error(data?.error ?? "Failed to load month");

            // update state
            state = {
                monthKey: data.monthKey,
                prevMonthKey: data.prevMonthKey,
                nextMonthKey: data.nextMonthKey,
            };

            setNavDisabled(state.prevMonthKey, state.nextMonthKey);
            renderWinners(data.monthLabel, data.raffleTitle, data.winners);

            if (pushUrl) {
                const nextUrl = new URL(window.location.href);
                nextUrl.searchParams.set("month", state.monthKey);
                window.history.replaceState({}, "", nextUrl.toString());
            }
        }

        function bindNav() {
            if (prevBtn instanceof HTMLButtonElement) {
                prevBtn.addEventListener("click", async () => {
                    const target = prevBtn.dataset.targetMonth;
                    if (!target) return;
                    await loadMonth(target);
                });
            }
            if (nextBtn instanceof HTMLButtonElement) {
                nextBtn.addEventListener("click", async () => {
                    const target = nextBtn.dataset.targetMonth;
                    if (!target) return;
                    await loadMonth(target);
                });
            }
        }

        // init: disable buttons based on SSR state, bind once
        setNavDisabled(state.prevMonthKey, state.nextMonthKey);
        bindNav();
    </script>

    <style>
        .hero {
            margin-top: var(--section-gap);
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }
        .kicker { color: var(--muted); font-weight: 800; letter-spacing: .3px; }
        .lead { margin: 0; max-width: 70ch; }

        .heroCtas { display: flex; gap: .75rem; flex-wrap: wrap; margin-top: var(--section-gap); }
        .fine { margin: .75rem 0 0; color: var(--muted); font-size: .95rem; }

        .infoCard {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.25rem;
            background: rgba(0,0,0,0.28);
            backdrop-filter: blur(2px);
        }
        .infoTitle { font-weight: 900; margin-bottom: .25rem; }
        .muted { color: var(--muted); }

        .sectionTitle { margin: 0 0 1rem; font-size: 1.35rem; }

        .blank {
            background: transparent;
            border: 1px dashed rgba(255,255,255,0.08);
        }

        .rules {
            margin-top: var(--section-gap);
            margin-bottom: calc(var(--section-gap) * 1.25);
            padding: 1.5rem 1.75rem;
            border-radius: 14px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
        }
        .rules ul { margin: 0; padding-left: 1.1rem; color: var(--muted); }
        .rules li { margin: 0.4rem 0;
            line-height: 1.5; }
        .liveCard{
            margin-top: var(--section-gap);
            padding: 1.5rem;
        }

        .livePanel{
            display: grid;
            gap: 1rem;
        }

        .liveFrame{
            aspect-ratio: 16 / 9;
            width: 100%;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: rgba(0,0,0,0.20);
        }

        .fbFrame{
            width: 100%;
            height: 100%;
            border: 0;
            display: block;
        }

        .liveFallback{
            display: flex;
            gap: .75rem;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .liveFrame--empty{
            display:flex;
            align-items:center;
            justify-content:center;
            padding: 1.25rem;
        }

        .liveOverlay{
            text-align:center;
            max-width: 60ch;
        }

        /* make the Facebook CTA feel intentional without changing global .btn */
        .fbBtn{
            border-color: rgba(24,119,242,0.35);
        }
        .fbBtn:hover,
        .fbBtn:focus-visible{
            border-color: rgba(24,119,242,0.55);
        }

        .winnersCard{
            margin-top: var(--section-gap);
            padding: 1.5rem;
        }

        .winnersPanel{
            padding: 1rem;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: rgba(0,0,0,0.28);
            backdrop-filter: blur(2px);
        }

        .winnersTableWrap{
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            background: rgba(0,0,0,0.18);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .winnersTable{
            table-layout: fixed;
            width: 100%;
            min-width: 860px;
            border-collapse: collapse;
        }

        .winnersTable th,
        .winnersTable td{
            padding: .85rem 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            color: var(--text);
            font-size: .98rem;
        }

        .winnersTable th{
            color: var(--text-strong);
            font-weight: 800;
            background: rgba(0,0,0,0.22);
        }

        .winnersTable th:nth-child(1),
        .winnersTable td:nth-child(1),
        .winnersTable th:nth-child(2),
        .winnersTable td:nth-child(2) {
            white-space: nowrap;
        }

        .winnersTable th:nth-child(1), .winnersTable td:nth-child(1) { width: 8.5rem; } /* Date */
        .winnersTable th:nth-child(2), .winnersTable td:nth-child(2) { width: 6.5rem; } /* Ticket */

        .monthNav{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:.75rem;
            margin-bottom: 1rem;
        }

        .monthNavCenter{
            text-align:center;
            min-width: 12rem;
        }

        .monthNavLabel{
            font-weight: 900;
        }

        @media (min-width: 980px) {
            .hero { grid-template-columns: 1.35fr .65fr; align-items: start; }
        }
        @media (min-width: 760px) and (max-width: 979px) {
            .hero { grid-template-columns: 1fr; }
            .heroCtas { gap: .6rem; }
        }

        @media (max-width: 520px) {
            .heroCtas { flex-direction: column; align-items: stretch; }
            .heroCtas .btn { width: 100%; }
            .liveFallback{
                flex-direction: column;
                align-items: stretch;
            }
            .liveFallback .btn{
                width: 100%;
                justify-content: center;
            }
            .monthNav{gap:.5rem;}
            .monthNavCenter{min-width: 9rem;}
        }
    </style>
</BaseLayout>

