---
import type { D1Database } from "@cloudflare/workers-types";
import BaseLayout from "../layouts/BaseLayout.astro";
export const prerender = false;

const raffleKey = "2025-30day-30gun";
const facebookPageReelsUrl =
    "https://www.facebook.com/61552199315213/reels/";

const facebookPageLiveUrl = "https://www.facebook.com/61552199315213/videos/";

const rules = [
    "Drawing at 6pm EVERYDAY in November.",
    "All proceeds go to Lake Henry Project.",
    "If drawn, name goes in for remaining drawings.",
    'Every firearm has a minimum value of $1000; $800 cash option if you do not choose the firearm.',
    "All State & Federal laws apply; MUST be 21 or older to purchase a ticket.",
];

type LiveConfig = { latestVideoUrl: string | null; previousVideoUrl?: string | null; updatedAt: string | null };
type WinnerRow = {
    id: string;
    drawDate: string;
    ticketNumber: number;
    name: string;
    town: string;
};

const env = Astro.locals.runtime.env;
const DB = env.DB as D1Database | undefined;

let winners: WinnerRow[] = [];
if (DB) {
    const { results } = await DB.prepare(
        `SELECT id,
            draw_date as drawDate,
            ticket_number as ticketNumber,
            winner_name as name,
            town
     FROM raffle_winners
     WHERE raffle_key = ?
     ORDER BY draw_date DESC`
    ).bind(raffleKey).all();
    winners = (results ?? []) as any;
}

let liveConfig: LiveConfig = { latestVideoUrl: null, previousVideoUrl: null,  updatedAt: null };

try {
    const raw = await env.CONFIG?.get("raffle_live");

    if (raw) {
        const parsed = JSON.parse(raw) as Partial<LiveConfig>;
        const cur = typeof parsed.latestVideoUrl === "string" ? parsed.latestVideoUrl.trim() : "";
        const prev = typeof parsed.previousVideoUrl === "string" ? parsed.previousVideoUrl.trim() : "";
        liveConfig = {
            latestVideoUrl: cur.length ? cur : null,
            previousVideoUrl: prev.length ? prev : null,
            updatedAt: typeof parsed.updatedAt === "string" ? parsed.updatedAt : null,
        };
    }
} catch {
    // ignore bad KV / parse
}

const effectiveVideoUrl = liveConfig.latestVideoUrl ?? liveConfig.previousVideoUrl ?? null;

const embedSrc = effectiveVideoUrl
    ? `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(effectiveVideoUrl)}&show_text=0&adapt_container_width=true`
    : null;

const updatedAtDate = liveConfig.updatedAt ? new Date(liveConfig.updatedAt) : null;
const updatedAtLabel =
    updatedAtDate && Number.isFinite(updatedAtDate.getTime()) ? updatedAtDate.toLocaleString("en-US", { timeZone: "America/Chicago" }) : null;
---

<BaseLayout title={`Raffle | Friends of Lake Henry`}>
    <div class="container">
        <section class="card hero enter-block">
            <div class="heroLeft">
                <div class="kicker">Friends of Lake Henry</div>
                <h1>Raffle Winners & Live Drawings</h1>
                <p class="lead">
                    Watch drawings on Facebook Live and see winners from past raffles.
                </p>

                <div class="heroCtas">
                    <a class="btn btn--facebook enter-block delay-1" href={facebookPageLiveUrl} target="_blank" rel="noopener noreferrer">Live videos</a>
                    <a class="btn  btn--facebook enter-block delay-2" href={facebookPageReelsUrl} target="_blank" rel="noopener noreferrer">Winner reels</a>
                </div>

                <p class="fine">
                    Ticket sales and raffle details will be posted when available.
                </p>
            </div>

            <div class="heroRight">
                <div class="infoCard enter-block delay-3">
                    <div class="infoTitle">Friends of Lake Henry</div>
                    <div class="muted">P.O. Box 142, Blair, WI 54616</div>
                    <div class="muted">Phone: 608-484-9241</div>
                    <div class="muted" style="margin-top:.5rem;">
                        Winners are posted on Facebook.
                    </div>
                </div>
            </div>
        </section>

        <section class="card liveCard enter-block delay-3">
            <h2 class="sectionTitle">Latest Live Stream</h2>

            <div class="panel livePanel enter-block delay-4">
                {embedSrc ? (
                    <div class="liveFrame">
                        <iframe
                            class="fbFrame"
                            src={embedSrc}
                            title="Friends of Lake Henry â€” Facebook Live"
                            loading="lazy"
                            allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"
                            allowfullscreen
                        ></iframe>
                    </div>
                ) : (
                    <div class="liveFrame liveFrame--empty">
                        <div class="liveOverlay">
                            <p class="muted" style="margin:0 0 .75rem;">
                                Live is offline right now. Watch on Facebook for the newest broadcast.
                            </p>
                            <a class="btn  btn--facebook" href={facebookPageLiveUrl} target="_blank" rel="noopener noreferrer">
                                Watch on Facebook
                            </a>
                        </div>
                    </div>
                )}

                {updatedAtLabel && (
                    <p class="muted" style="margin:.5rem 0 0;">Last updated: {updatedAtLabel}</p>
                )}

                {embedSrc && (
                    <div class="liveFallback enter-block delay-5">
                        <a class="btn  btn--facebook" href={facebookPageLiveUrl} target="_blank" rel="noopener noreferrer">
                            Watch on Facebook
                        </a>
                    </div>
                )}
            </div>
        </section>

        <section class="card winnersCard enter-block delay-6">
            <h2 class="sectionTitle">Past Winners</h2>

            <div class="panel winnersPanel">
                {winners.length ? (
                    <div class="winnersTableWrap" role="region" aria-label="Raffle winners list">
                        <table class="winnersTable enter-block delay-7">
                            <thead>
                            <tr>
                                <th scope="col">Date</th>
                                <th scope="col">Ticket</th>
                                <th scope="col">Name</th>
                                <th scope="col">Town</th>
                            </tr>
                            </thead>
                            <tbody>
                            {winners.map((w) => (
                                <tr>
                                    <td>{w.drawDate}</td>
                                    <td>{w.ticketNumber}</td>
                                    <td>{w.name}</td>
                                    <td>{w.town}</td>
                                </tr>
                            ))}
                            </tbody>
                        </table>
                    </div>
                ) : (
                    <p class="muted" style="margin:0;">
                        Winners will appear here after the first drawing.
                    </p>
                )}
            </div>
        </section>

        <section class="card rules  enter-block delay-8">
            <h2>Rules</h2>
            <ul>
                {rules.map((r) => <li>{r}</li>)}
            </ul>
        </section>
    </div>

    <style>
        .hero {
            margin-top: var(--section-gap);
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }
        .kicker { color: var(--muted); font-weight: 800; letter-spacing: .3px; }
        .lead { margin: 0; max-width: 70ch; }

        .heroCtas { display: flex; gap: .75rem; flex-wrap: wrap; margin-top: var(--section-gap); }
        .fine { margin: .75rem 0 0; color: var(--muted); font-size: .95rem; }

        .infoCard {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.25rem;
            background: rgba(0,0,0,0.28);
            backdrop-filter: blur(2px);
        }
        .infoTitle { font-weight: 900; margin-bottom: .25rem; }
        .muted { color: var(--muted); }

        .sectionTitle { margin: 0 0 1rem; font-size: 1.35rem; }

        .blank {
            background: transparent;
            border: 1px dashed rgba(255,255,255,0.08);
        }

        .rules {
            margin-top: var(--section-gap);
            margin-bottom: calc(var(--section-gap) * 1.25);
            padding: 1.5rem 1.75rem;
            border-radius: 14px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
        }
        .rules ul { margin: 0; padding-left: 1.1rem; color: var(--muted); }
        .rules li { margin: 0.4rem 0;
            line-height: 1.5; }
        .liveCard{
            margin-top: var(--section-gap);
            padding: 1.5rem;
        }

        .livePanel{
            display: grid;
            gap: 1rem;
        }

        .liveFrame{
            aspect-ratio: 16 / 9;
            width: 100%;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: rgba(0,0,0,0.20);
        }

        .fbFrame{
            width: 100%;
            height: 100%;
            border: 0;
            display: block;
        }

        .liveFallback{
            display: flex;
            gap: .75rem;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .liveFrame--empty{
            display:flex;
            align-items:center;
            justify-content:center;
            padding: 1.25rem;
        }

        .liveOverlay{
            text-align:center;
            max-width: 60ch;
        }

        /* make the Facebook CTA feel intentional without changing global .btn */
        .fbBtn{
            border-color: rgba(24,119,242,0.35);
        }
        .fbBtn:hover,
        .fbBtn:focus-visible{
            border-color: rgba(24,119,242,0.55);
        }

        .winnersCard{
            margin-top: var(--section-gap);
            padding: 1.5rem;
        }

        .winnersPanel{
            padding: 1rem;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: rgba(0,0,0,0.20);
        }

        .winnersTableWrap{
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
        }

        .winnersTable{
            width: 100%;
            border-collapse: collapse;
            min-width: 720px;
        }

        .winnersTable th,
        .winnersTable td{
            padding: .7rem .75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            color: var(--text);
            font-size: .98rem;
        }

        .winnersTable th{
            color: var(--text-strong);
            font-weight: 800;
            background: rgba(255,255,255,0.03);
        }

        @media (min-width: 980px) {
            .hero { grid-template-columns: 1.35fr .65fr; align-items: start; }
        }
        @media (min-width: 760px) and (max-width: 979px) {
            .hero { grid-template-columns: 1fr; }
            .heroCtas { gap: .6rem; }
        }

        @media (max-width: 520px) {
            .heroCtas { flex-direction: column; align-items: stretch; }
            .heroCtas .btn { width: 100%; }
            .liveFallback{
                flex-direction: column;
                align-items: stretch;
            }
            .liveFallback .btn{
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</BaseLayout>

