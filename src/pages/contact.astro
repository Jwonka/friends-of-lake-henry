---
import BaseLayout from "../layouts/BaseLayout.astro";
export const prerender = false;
const env = (Astro.locals as any).runtime?.env as { PUBLIC_TURNSTILE_KEY?: string } | undefined;
const siteKey = String(env?.PUBLIC_TURNSTILE_KEY ?? "").trim();
---

<BaseLayout title="Contact | Friends of Lake Henry">
    <div class="container">
        <section id="contact" class="contactSection card enter-block">
            <h1>Contact</h1>
            <div class="panel enter-block delay-1">
                <h2 class="subhead">Get in touch</h2>
                <p class="intro">
                    <span class="line1">Have a question, want to volunteer, or need raffle information?</span>
                    <span class="line2">Send us a message and we’ll get back to you.</span>
                </p>

                <div id="status" class="status status--empty" role="status" aria-live="polite" aria-atomic="true" tabindex="-1"></div>

                <form class="form" method="post" action="/api/contact">
                    <div class="row">
                        <label  class="field">
                            <span class="labelRow">
                                Name<span class="req" aria-hidden="true">*</span>
                                <span class="srOnly">(required)</span>
                            </span>
                            <input name="name" autocomplete="name" placeholder="John Doe" required />
                        </label>
                        <label  class="field">
                            <span class="labelRow">
                                Email<span class="req" aria-hidden="true">*</span>
                                <span class="srOnly">(required)</span>
                            </span>
                            <input name="email" type="email" autocomplete="email" placeholder="example@gmail.com" required />
                        </label>
                    </div>

                    <label  class="field">
                        <span class="labelRow">
                            Message<span class="req" aria-hidden="true">*</span>
                            <span class="srOnly">(required)</span>
                        </span>
                        <textarea name="message" rows="6" required minlength="10"></textarea>
                    </label>

                    <!-- Honeypot -->
                    <div class="hp" aria-hidden="true">
                        <label>
                            Company
                            <input type="text" name="company" tabindex="-1" autocomplete="off" />
                        </label>
                    </div>

                    <!-- Turnstile widget -->
                    <div id="ts" data-sitekey={siteKey}>
                    </div>

                    <div class="ctaRow enter-block delay-2">
                        <button class="btn" type="submit">Send message</button>
                    </div>

                    <p class="fine muted">
                        By submitting, you agree we may contact you back about your request.
                    </p>
                </form>
                <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" defer></script>
            </div>
        </section>
    </div>
    <script is:inline>
        (function () {
            const form = document.querySelector("form.form");
            const container = document.getElementById("ts");
            const statusEl = document.getElementById("status");
            if (!form || !container || !statusEl) return;

            const sitekey = (container.getAttribute("data-sitekey") || "").trim();
            let widgetId = null;

            function show(kind, msg) {
                statusEl.textContent = msg;
                statusEl.classList.remove("status--empty", "status--success", "status--error");
                statusEl.classList.add(kind === "ok" ? "status--success" : "status--error");
                try { statusEl.focus(); } catch {}
            }

            if (!sitekey) {
                show("err", "Contact form is not configured yet. Please try again later.");
                return;
            }

            async function submitViaFetch(token) {
                const fd = new FormData(form);
                fd.set("cf-turnstile-response", token);

                try {
                    const res = await fetch(form.action, {
                        method: "POST",
                        body: fd,
                        headers: { "accept": "application/json" },
                    });

                    const data = await res.json().catch(() => ({}));
                    if (!res.ok || !data?.ok) {
                        const code = data?.error || "server";
                        show("err",
                            code === "captcha" ? "Verification failed. Please try again."
                                : code === "input" ? "Please check your details and try again."
                                    : "Sorry, something went wrong. Please try again."
                        );
                        return;
                    }

                    show("ok", "Thanks! We’ll be in touch shortly.");
                    form.reset();
                } catch {
                    show("err", "Sorry, something went wrong. Please try again.");
                } finally {
                    form.dataset.tsPending = "";
                    if (window.turnstile && widgetId != null) {
                        try { window.turnstile.reset(widgetId); } catch {}
                    }
                }
            }

            function initTurnstile() {
                if (!window.turnstile || widgetId != null) return;
                widgetId = window.turnstile.render(container, {
                    sitekey,
                    execution: "execute",
                    appearance: "execute",
                    callback: (token) => submitViaFetch(token),
                    "error-callback": () => {
                        form.dataset.tsPending = "";
                        show("err", "Verification failed. Please try again.");
                    },
                });
            }

            window.addEventListener("load", initTurnstile);

            form.addEventListener("submit", (e) => {
                if (form.dataset.tsPending === "1") return;
                e.preventDefault();
                form.dataset.tsPending = "1";

                initTurnstile();

                if (!window.turnstile || widgetId == null) {
                    form.dataset.tsPending = "";
                    show("err", "Verification is still loading. Please try again.");
                    return;
                }

                show("ok", "Verifying…");
                window.turnstile.execute(widgetId);
            });
        })();
    </script>
    <style>
        .contactSection{ margin-top: var(--section-gap); margin-bottom: calc(var(--section-gap) * 1.25); }
        .intro{
            margin: 0 0 1rem;
            color: var(--text-soft);
            line-height: 1.6;
        }
        .subhead{
            margin: 0 0 .4rem;
            font-size: 1.25rem;
            color: var(--text-strong);
        }
        /* Desktop: two clean lines */
        .intro .line1,
        .intro .line2{
            display: block;
        }

        /* Small screens: treat as one sentence (no weird two-line look) */
        @media (max-width: 720px){
            .intro .line1,
            .intro .line2{
                display: inline;
            }
            .intro .line1::after{
                content: " ";
            }
        }

        .form { margin-top: 1rem; display: grid; gap: 1rem; }
        .row { display: grid; gap: 1rem; grid-template-columns: 1fr; }
        .field { display: grid; gap: 0.4rem; }

        .labelRow{
            display: inline-flex;
            align-items: baseline;
            gap: 0.25rem;
            font-weight: 750;
        }
        .ctaRow{
            display:flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: .35rem;
        }
        /* Honeypot */
        .hp {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        @media (min-width: 860px){
            .row{ grid-template-columns: 1fr 1fr; }
        }

        .fine{
            margin: .65rem 0 0;
            font-size: .95rem;
            color: var(--text-soft);
            opacity: .9;
        }

        /* Mobile: make submit feel intentional */
        @media (max-width: 520px){
            .form .btn{ width: 100%; justify-content: center; }
        }

    </style>
</BaseLayout>
