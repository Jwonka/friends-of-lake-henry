---
export const prerender = false;

import BaseLayout from "../../../layouts/BaseLayout.astro";
import type { D1Database } from "@cloudflare/workers-types";
const categories = ["Restoration", "Donations", "Community Events", "Raffles", "Scenery"];

const DB = (Astro.locals as any).runtime.env.DB as D1Database;

const rows = await DB.prepare(`
    SELECT id, r2_key, category, title, caption, alt, submitted_by, submitted_at
    FROM photos
    WHERE status = 'pending'
    ORDER BY submitted_at DESC
`).all();

const pending = rows.results ?? [];
const ok = Astro.url.searchParams.get("ok");
const err = Astro.url.searchParams.get("err");
const statusClass =
    ok ? "status--success" :
        err ? "status--error" :
            "status--empty";

const statusMsg =
    ok === "approved" ? "Approved. Photo is now public." :
        ok === "rejected" ? "Rejected. Photo deleted." :
            err === "server" ? "Server error. Try again." :
                err ? "Something went wrong. Try again." :
                    "";
---

<BaseLayout title="Pending Photos | Admin">
    <div class="container" style="--maxw: 1100px;">
        <section class="card pendingCard enter-block">
            <div class="adminHeader">
                <div class="adminHeaderLeft">
                    <a class="pill" href="/admin">Admin</a>
                    <h1 class="h1-tight">Pending photos</h1>
                    <p class="lead">Approve to publish. Reject deletes the image and the DB row.</p>
                    <div id="status" class={`status ${statusClass}`} style="text-align: center;" role="status" aria-live="polite" aria-atomic="true" tabindex="-1">
                        {statusMsg}
                    </div>
                </div>
            </div>

            <div class="panel pendingPanel enter-block delay-1">
                {pending.length === 0 ? (
                    <div class="emptyState">
                        <p class="muted">No pending photos.</p>
                    </div>
                ) : (
                    <div class="pendingList">
                        {pending.map((p: any) => (
                            <article class="pendingItem panel">
                                <div class="itemGrid">
                                    {/* Preview */}
                                    <a class="previewLink" href={`/api/admin/photos/file?id=${p.id}`} target="_blank" rel="noopener">
                                        <img
                                            class="previewImg"
                                            src={`/api/admin/photos/file?id=${p.id}`}
                                            alt=""
                                            loading="lazy"
                                        />
                                    </a>

                                    {/* Details + Actions */}
                                    <div class="itemBody">
                                        <div class="meta">
                                            <div class="metaRow">
                                                <span class="metaLabel">Submitted</span>
                                                <span class="metaValue">{p.submitted_at}</span>
                                            </div>
                                            {p.submitted_by ? (
                                                    <div class="metaRow">
                                                        <span class="metaLabel">By</span>
                                                        <span class="metaValue">{p.submitted_by}</span>
                                                    </div>
                                            ) : null}
                                            <div class="metaRow">
                                                <span class="metaLabel">ID</span>
                                                <span class="metaValue mono">{p.id}</span>
                                            </div>
                                        </div>

                                        <form method="post" action="/api/admin/photos/approve" class="form approveForm">
                                            <input type="hidden" name="id" value={p.id} />

                                            <label class="field">
                                                <span class="labelRow">Category<span class="req" aria-hidden="true">*</span></span>
                                                <select name="category" class="selectGlass" required>
                                                    {categories.map((c) => (
                                                            <option value={c} selected={p.category === c}>{c}</option>
                                                    ))}
                                                </select>
                                            </label>

                                            <label class="field">
                                                <span class="labelRow">Alt text<span class="req" aria-hidden="true">*</span></span>
                                                <input name="alt" value={p.alt ?? ""} required minlength="5" />
                                                <p class="help small">
                                                    Keep it short and specific. Example: “Kids holding raffle tickets in front of the Lake Henry sign.”
                                                </p>
                                            </label>

                                            <div class="row row2">
                                                <label class="field">
                                                    <span class="labelRow">Title</span>
                                                    <input name="title" value={p.title ?? ""} />
                                                </label>

                                                <label class="field">
                                                    <span class="labelRow">Caption</span>
                                                    <input name="caption" value={p.caption ?? ""} />
                                                </label>
                                            </div>

                                            <div class="ctaRow actions">
                                                <button class="btn" type="submit">Approve</button>

                                                <button
                                                    class="pill pill--danger"
                                                    type="submit"
                                                    form={`reject-${p.id}`}
                                                    onclick="return confirm('Reject this photo? This permanently deletes the image and record.');"
                                                >
                                                    Reject
                                                </button>
                                            </div>
                                        </form>

                                        <form id={`reject-${p.id}`} method="post" action="/api/admin/photos/reject">
                                            <input type="hidden" name="id" value={p.id} />
                                        </form>
                                    </div>
                                </div>
                            </article>
                        ))}
                    </div>
                )}
            </div>
        </section>
    </div>
    <script type="module">
        import { cleanFlashParams } from "../../../scripts/clean-flash";
        cleanFlashParams(["ok", "err"]);
    </script>
    <style>
        .pendingCard { margin-top: var(--section-gap); }

        .pendingPanel{
            background: var(--panel-bg-dense);
            border-color: rgba(255,255,255,0.14);
            padding: 1.25rem;
        }

        .pendingList{
            display: grid;
            gap: 1rem;
        }

        .pendingItem{
            background: var(--glass-dark);
            border: 1px solid var(--border-strong);
            box-shadow: var(--card-shadow-soft);
            border-radius: 16px;
            overflow: hidden;
            padding: 1rem;
        }

        .itemGrid{
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        .previewLink{
            display:block;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--border-strong);
            background: rgba(0,0,0,0.18);
            box-shadow: var(--card-shadow-soft);
            transition: transform 140ms ease, box-shadow 160ms ease, border-color 160ms ease;
        }

        .previewLink:hover,
        .previewLink:focus-visible{
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-strong);
            border-color: rgba(255,255,255,0.22);
        }

        .previewImg{
            width: 100%;
            height: auto;
            display:block;
            aspect-ratio: 4 / 3;
            object-fit: cover;
            transform: translateZ(0);
        }

        .itemBody{
            display: grid;
            gap: 0.9rem;
        }

        .selectGlass{
            width: 100%;
            background: var(--glass-light);
            border: 1px solid var(--border-strong);
            color: var(--text-bright);
            border-radius: 12px;
            padding: 0.85rem 2.25rem 0.85rem 0.9rem;
            line-height: 1.2;

            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;

            /* custom arrow */
            background-image:
                    linear-gradient(45deg, transparent 50%, var(--text-soft) 50%),
                    linear-gradient(135deg, var(--text-soft) 50%, transparent 50%);
            background-position:
                    calc(100% - 18px) calc(50% - 3px),
                    calc(100% - 12px) calc(50% - 3px);
            background-size: 6px 6px;
            background-repeat: no-repeat;
        }

        .selectGlass:focus,
        .selectGlass:focus-visible{
            outline: none;
            border-color: var(--border-bright-strong);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.12);
        }

        /* Some browsers ignore option styling, but this helps where supported */
        .selectGlass option{
            background: var(--surface);
            color: var(--text);
        }

        .meta{
            display:grid;
            gap: 0.35rem;
            padding: 0.75rem 0.85rem;
            border-radius: 14px;
            background: rgba(0,0,0,0.18);
            border: 1px solid rgba(255,255,255,0.12);
        }

        .metaRow{
            display:flex;
            justify-content: space-between;
            gap: 0.75rem;
            align-items: baseline;
        }

        .metaLabel{
            color: var(--text-soft);
            font-weight: 700;
            font-size: 0.95rem;
        }

        .metaValue{
            color: var(--text-strong);
            font-weight: 650;
            text-align: right;
        }

        .mono{
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9rem;
            opacity: 0.95;
            overflow-wrap: anywhere;
        }

        .approveForm{ display:grid; gap: 0.9rem; }

        .help.small{
            margin: 0.25rem 0 0;
            font-size: 0.92rem;
            color: var(--text-soft);
            line-height: 1.45;
        }

        .row2{
            display:grid;
            gap: 1rem;
            grid-template-columns: 1fr;
            align-items: end;
        }

        .actions{
            display:flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Make reject visually distinct but still “site-native” */
        .pill--danger{
            background: var(--glass-dark);
            border-color: rgba(255,255,255,0.18);
            color: var(--text-on-dark);
            position: relative;
            overflow: hidden;
        }
        .pill--danger::before{
            content:"";
            position:absolute;
            inset:0;
            background: rgba(239,68,68,0.22); /* red tint */
            pointer-events:none;
        }
        .pill--danger:hover::before,
        .pill--danger:focus-visible::before{
            background: rgba(239,68,68,0.32);
        }

        /* Desktop: image left, forms right */
        @media (min-width: 920px){
            .pendingItem{ padding: 1.1rem; }

            .itemGrid{
                grid-template-columns: 420px 1fr;
                align-items: start;
            }

            .row2{
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Mobile: stack buttons full width for easy tapping */
        @media (max-width: 520px){
            .pendingPanel{ padding: 1rem; }
            .actions{
                flex-direction: column;
                align-items: stretch;
            }
            .actions .btn,
            .actions .pill{
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</BaseLayout>
