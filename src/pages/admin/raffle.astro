---
import BaseLayout from "../../layouts/BaseLayout.astro";
export const prerender = false;
---

<BaseLayout title="Admin | Raffle | Friends of Lake Henry">
    <div class="container" style="--maxw: 1100px;">
        <section class="card adminCard enter-block">
            <div class="adminHeader">
                <div class="adminTitle">
                    <div class="pageTop">
                        <a class="pill enter-block delay-1" href="/admin">ADMIN</a>
                        <h1 class="h1-tight">Raffle</h1>
                    </div>
                    <p class="lead adminLead">Set the latest Facebook Live video shown on the public raffle page.</p>
                </div>
                <div class="adminActions">
                    <form class="logoutForm enter-block delay-1" method="post" action="/api/admin/logout">
                        <button class="btn" type="submit">Log out</button>
                    </form>
                </div>
            </div>
            <div id="pageStatus" class="status status--empty status--center" aria-live="polite"></div>
            <div class="panel adminPanel enter-block delay-2" style="margin-top: 1rem;">
                <div class="formGrid">
                    <div class="field span2">
                        <label class="label" for="latestVideoUrl">Latest Facebook Live video URL</label>
                        <input
                            id="latestVideoUrl"
                            class="input"
                            placeholder="https://www.facebook.com/<page>/videos/<id>"
                            inputmode="url"
                            autocomplete="off"
                        />
                        <div class="muted" style="margin-top:.35rem;">
                           <p>Paste the Facebook <strong>video</strong> URL for the current/most recent live.
                               **Leave <strong>blank</strong> and save to remove the latest live**</p>
                        </div>
                        <div class="muted" style="margin-top:.35rem;">
                            <p>If a previous video is available, the site will show that.
                            Otherwise it will show the “Watch on Facebook” button.</p>
                        </div>
                    </div>

                    <div class="actions span2 enter-block delay-3">
                        <button class="btn" id="saveLive" type="button">Save latest stream</button>
                        <a class="pill" href="/raffle">View public raffle page</a>
                    </div>
                    <div class="span2">
                        <div id="liveStatus" class="status status--empty status--center" aria-live="polite"></div>
                    </div>
                </div>
            </div>

            <div class="panel adminPanel enter-block delay-4" style="margin-top: 1rem;">
                <div class="adminHeaderRow">
                    <h2 class="h2-zero">Winners</h2>
                    <div class="muted">Raffle: <strong>2025</strong></div>
                </div>
                <div class="formGrid" style="margin-top: .85rem;">
                    <div class="field">
                        <label class="label" for="raffleMonth">Raffle month</label>
                        <input id="raffleMonth" class="input" type="month" autocomplete="off" />
                        <div class="muted" style="margin-top:.35rem;">
                            Select which month you’re editing.
                        </div>
                        <div class="muted" style="margin-top:.1rem;">
                            **Winners and raffle title are saved per month**
                        </div>
                    </div>

                    <div class="field span2">
                        <label class="label" for="raffleTitle">Raffle title (optional)</label>
                        <input id="raffleTitle" class="input" placeholder="30 Day / 30 Gun" autocomplete="off" />
                        <div class="muted" style="margin-top:.35rem;">
                            If set, this title will appear on the public raffle page for the selected month.
                        </div>
                        <div class="muted" style="margin-top:.1rem;">
                            **Leave blank and save to remove the title**
                        </div>
                    </div>

                    <div class="actions span2">
                        <button class="btn" id="saveRaffleMeta" type="button">Save raffle title</button>
                    </div>

                    <div class="span2">
                        <div id="metaStatus" class="status status--empty status--center" aria-live="polite"></div>
                    </div>
                </div>

                <div class="formGrid" style="margin-top: .85rem;">
                    <div class="field">
                        <label class="label" for="wDate">Date</label>
                        <input id="wDate" class="input" type="date" autocomplete="off" />
                    </div>

                    <div class="field">
                        <label class="label" for="wTicket">Ticket #</label>
                        <input id="wTicket" class="input" inputmode="numeric" placeholder="66" autocomplete="off" />
                    </div>

                    <div class="field span2">
                        <label class="label" for="wName">Name</label>
                        <input id="wName" class="input" placeholder="Kurt Thesing" autocomplete="off" />
                    </div>

                    <div class="field span2">
                        <label class="label" for="wTown">Town</label>
                        <input id="wTown" class="input" placeholder="Galesville" autocomplete="off" />
                    </div>

                    <div class="actions span2">
                        <button class="btn" id="addWinner" type="button">Add winner</button>
                    </div>

                    <div class="span2">
                        <div id="winnersStatus" class="status status--empty status--center" aria-live="polite"></div>
                    </div>
                </div>

                <div class="winnersList" style="margin-top: 1rem;">
                    <div class="muted" id="winnersCount" style="margin:0 0 .5rem;"></div>
                    <div class="winnersTableWrap" role="region" aria-label="Admin winners list">
                        <table class="winnersTable" id="winnersTable">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ticket</th>
                                <th>Name</th>
                                <th>Town</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        function currentMonthKeyChicago() {
            // en-CA => YYYY-MM formatting is easy to slice
            return new Intl.DateTimeFormat("en-CA", {
                timeZone: "America/Chicago",
                year: "numeric",
                month: "2-digit",
                }).format(new Date()).slice(0, 7);
            }

        function monthKeyToLabel(monthKey) {
            const [y, m] = monthKey.split("-").map(Number);
            const d = new Date(Date.UTC(y, m - 1, 15, 12));
            return new Intl.DateTimeFormat("en-US", {
                timeZone: "America/Chicago",
                month: "long",
                year: "numeric",
            }).format(d);
        }
        const pageStatus = document.getElementById("pageStatus");

        function setPageStatus(kind, msg) {
            if (!(pageStatus instanceof HTMLElement)) return;
            if (!msg) {
                pageStatus.className = "status status--empty status--center";
                pageStatus.textContent = "";
                return;
            }
            pageStatus.className = `status status--${kind} status--center`;
            pageStatus.textContent = msg;
        }
        const raffleMonth = document.getElementById("raffleMonth");
        const raffleTitle = document.getElementById("raffleTitle");
        const saveRaffleMetaBtn = document.getElementById("saveRaffleMeta");
        const metaStatus = document.getElementById("metaStatus");
        const input = document.getElementById("latestVideoUrl");
        const btn = document.getElementById("saveLive");
        const liveStatus = document.getElementById("liveStatus");

        function setLiveStatus(kind, msg) {
            if (!(liveStatus instanceof HTMLElement)) return;
            if (!msg) {
                liveStatus.className = "status status--empty status--center";
                liveStatus.textContent = "";
                return;
            }
            liveStatus.className = `status status--${kind} status--center`;
            liveStatus.textContent = msg;
        }

        function setMetaStatus(kind, msg) {
            if (!(metaStatus instanceof HTMLElement)) return;
            if (!msg) {
                metaStatus.className = "status status--empty status--center";
                metaStatus.textContent = "";
                return;
            }
            metaStatus.className = `status status--${kind} status--center`;
            metaStatus.textContent = msg;
        }

        if (
            !(input instanceof HTMLInputElement) ||
            !(btn instanceof HTMLButtonElement) ||
            !(liveStatus instanceof HTMLElement)
        ) {
            setPageStatus("error", "Live settings UI failed to initialize. Reload the page.");
        } else {

            async function load() {
                setLiveStatus("info", "Loading current setting");
                try {
                    const res = await fetch("/api/admin/raffle/live", {headers: {"Accept": "application/json"}});
                    const data = await res.json().catch(() => ({}));
                    if (res.ok && data?.ok) {
                        input.value = data.config?.latestVideoUrl ?? "";
                        setLiveStatus("info", "Loaded current latest stream setting.");
                    } else {
                        setLiveStatus("error", data?.error ?? "Failed to load live config.");
                    }
                } catch {
                    setLiveStatus("error", "Failed to load live config.");
                }
            }

            btn.addEventListener("click", async () => {
                setLiveStatus("success", "Saving...");
                btn.disabled = true;
                btn.setAttribute("aria-disabled", "true");

                try {
                    const res = await fetch("/api/admin/raffle/live", {
                        method: "POST",
                        headers: {"Content-Type": "application/json", "Accept": "application/json"},
                        body: JSON.stringify({latestVideoUrl: input.value.trim()}),
                    });

                    const data = await res.json().catch(() => ({}));

                    if (res.ok && data?.ok) {
                        const v = data.config?.latestVideoUrl;
                        setLiveStatus("info", v ? "Saved. The raffle page will show this latest stream." : "Cleared. The raffle page will show the previous Facebook live.");
                    } else {
                        setLiveStatus("error", data?.error ?? "Save failed.");
                    }
                } catch {
                    setLiveStatus("error", "Save failed.");
                } finally {
                    btn.disabled = false;
                    btn.setAttribute("aria-disabled", "false");
                }
            });

            load();
        }

        const wDate = document.getElementById("wDate");
        const wTicket = document.getElementById("wTicket");
        const wName = document.getElementById("wName");
        const wTown = document.getElementById("wTown");
        const addWinnerBtn = document.getElementById("addWinner");
        const winnersStatus = document.getElementById("winnersStatus");
        const winnersTable = document.getElementById("winnersTable");
        const winnersCount = document.getElementById("winnersCount");

        function setWinnersStatus(kind, msg) {
            if (!(winnersStatus instanceof HTMLElement)) return;
            if (!msg) {
                winnersStatus.className = "status status--empty status--center";
                winnersStatus.textContent = "";
                return;
            }
            winnersStatus.className = `status status--${kind} status--center`;
            winnersStatus.textContent = msg;
        }

        if (
            !(wDate instanceof HTMLInputElement) ||
            !(wTicket instanceof HTMLInputElement) ||
            !(wName instanceof HTMLInputElement) ||
            !(wTown instanceof HTMLInputElement) ||
            !(addWinnerBtn instanceof HTMLButtonElement) ||
            !(winnersTable instanceof HTMLTableElement) ||
            !(winnersStatus instanceof HTMLElement) ||
            !(winnersCount instanceof HTMLElement) ||
            !(raffleMonth instanceof HTMLInputElement) ||
            !(raffleTitle instanceof HTMLInputElement) ||
            !(saveRaffleMetaBtn instanceof HTMLButtonElement) ||
            !(metaStatus instanceof HTMLElement)
        ) {
            setPageStatus("error", "Winners UI failed to initialize. Reload the page.");
        } else {
            if (!raffleMonth.value) {
                raffleMonth.value = currentMonthKeyChicago(); // YYYY-MM
            }
            if (!wDate.value) {
                wDate.value = `${raffleMonth.value}-01`; // keep date in selected month
            }
            const dateMonth = wDate.value.slice(0, 7);

            if (dateMonth !== raffleMonth.value) {
                wDate.value = `${raffleMonth.value}-01`;
            }

            function formatISODateMDY(iso) {
                if (!iso) return "";
                const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if (!m) return String(iso);
                const [, yyyy, mm, dd] = m;
                return `${mm}/${dd}/${yyyy}`;
            }

            function renderWinners(rows) {
                const tbody = winnersTable.tBodies?.[0];
                if (!tbody) return;

                tbody.replaceChildren();
                winnersCount.textContent = rows.length ? `${rows.length} winner(s)` : "No winners yet.";

                for (const r of rows) {
                    const tr = document.createElement("tr");

                    // Date cell
                    const tdDate = document.createElement("td");
                    tdDate.className = "tdDate";

                    const time = document.createElement("time");
                    const iso = String(r.drawDate ?? "");
                    time.setAttribute("datetime", iso);
                    time.textContent = formatISODateMDY(iso);
                    tdDate.appendChild(time);

                    // Ticket cell
                    const tdTicket = document.createElement("td");
                    tdTicket.textContent = String(r.ticketNumber ?? "");

                    // Name cell
                    const tdName = document.createElement("td");
                    tdName.textContent = String(r.name ?? "");

                    // Town cell
                    const tdTown = document.createElement("td");
                    tdTown.textContent = String(r.town ?? "");

                    // Remove button cell
                    const tdActions = document.createElement("td");
                    tdActions.style.textAlign = "right";

                    const btn = document.createElement("button");
                    btn.className = "pill";
                    btn.type = "button";
                    btn.setAttribute("data-del", String(r.id ?? ""));
                    btn.textContent = "Remove";

                    tdActions.appendChild(btn);

                    tr.append(tdDate, tdTicket, tdName, tdTown, tdActions);
                    tbody.appendChild(tr);
                    }
                }

            async function loadWinners() {
                setWinnersStatus("info", "Loading winners...");
                try {
                    const monthKey = raffleMonth.value || currentMonthKeyChicago();

                    const qs = new URLSearchParams({
                        raffleKey: monthKey,
                        includeMonths: "1",
                        includeMeta: "1",
                    });

                    const res = await fetch(`/api/admin/raffle/winners?${qs.toString()}`, {
                        headers: { "Accept": "application/json" }
                    });

                    const data = await res.json().catch(() => ({}));

                    if (res.ok && data?.ok) {
                        renderWinners(data.winners ?? []);
                        raffleTitle.value = (data.meta?.title ?? "").toString();
                        setWinnersStatus("info", "Winners loaded.");
                    } else {
                        setWinnersStatus("error", data?.error ?? "Failed to load winners.");
                    }
                } catch {
                    setWinnersStatus("error", "Failed to load winners.");
                }
            }

            raffleMonth.addEventListener("change", async () => {
                wDate.value = `${raffleMonth.value}-01`;
                setMetaStatus("info", "");
                setWinnersStatus("info", "");
                await loadWinners();
            });

            saveRaffleMetaBtn.addEventListener("click", async () => {
                const raffleKey = raffleMonth.value.trim();
                const title = raffleTitle.value.trim();

                setMetaStatus("success", "Saving...");
                saveRaffleMetaBtn.disabled = true;

                try {
                    const res = await fetch("/api/admin/raffle/winners", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Accept": "application/json" },
                        body: JSON.stringify({ action: "setMeta", raffleKey, title }),
                    });

                    const data = await res.json().catch(() => ({}));
                    if (res.ok && data?.ok) {
                        setMetaStatus("info", title ? "Saved." : "Cleared for this month.");
                    } else {
                        setMetaStatus("error", data?.error ?? "Save failed.");
                    }
                } catch {
                    setMetaStatus("error", "Save failed.");
                } finally {
                    saveRaffleMetaBtn.disabled = false;
                }
            });

            addWinnerBtn.addEventListener("click", async () => {
                const dateMonth = wDate.value.slice(0, 7);
                if (dateMonth !== raffleMonth.value) {
                    setWinnersStatus("error", `Date must be within ${monthKeyToLabel(raffleMonth.value)}.`);
                    return;
                }

                setWinnersStatus("success", "Saving...");
                addWinnerBtn.disabled = true;
                addWinnerBtn.setAttribute("aria-disabled", "true");

                try {
                    const payload = {
                        drawDate: wDate.value.trim(),
                        ticketNumber: wTicket.value.trim(),
                        name: wName.value.trim(),
                        town: wTown.value.trim(),
                    };

                    const res = await fetch("/api/admin/raffle/winners", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Accept": "application/json" },
                        body: JSON.stringify(payload),
                    });

                    const data = await res.json().catch(() => ({}));
                    if (res.ok && data?.ok) {
                        wTicket.value = "";
                        wName.value = "";
                        wTown.value = "";
                        // keep date for batch entry convenience
                        setWinnersStatus("info", "Winner saved.");
                        await loadWinners();
                    } else {
                        setWinnersStatus("error", data?.error ?? "Save failed.");
                    }
                } catch {
                    setWinnersStatus("error", "Save failed.");
                } finally {
                    addWinnerBtn.disabled = false;
                    addWinnerBtn.setAttribute("aria-disabled", "false");
                }
            });

            winnersTable.addEventListener("click", async (e) => {
                const btn = e.target?.closest?.("button[data-del]");
                if (!btn) return;

                const id = btn.getAttribute("data-del");
                if (!id) return;

                if (!confirm("Remove this winner?")) { btn.disabled = false; return; }

                btn.disabled = true;
                setWinnersStatus("success", "Removing...");

                try {
                    const res = await fetch("/api/admin/raffle/winners", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Accept": "application/json" },
                        body: JSON.stringify({ action: "delete", id }),
                    });
                    const data = await res.json().catch(() => ({}));
                    if (res.ok && data?.ok) {
                        setWinnersStatus("info", "Removed.");
                        await loadWinners();
                    } else {
                        setWinnersStatus("error", data?.error ?? "Remove failed.");
                    }
                } catch {
                    setWinnersStatus("error", "Remove failed.");
                } finally {
                    btn.disabled = false;
                }
            });
            wDate.addEventListener("change", () => {
                const dm = wDate.value.slice(0, 7);
                if (dm && dm !== raffleMonth.value) {
                    // keep the month selector consistent with the date they chose
                    raffleMonth.value = dm;
                    raffleMonth.dispatchEvent(new Event("change"));
                }
            });
            loadWinners();
        }
    </script>

    <style>
        .adminHeader{ display:flex; justify-content:space-between; gap:1rem; align-items:flex-end; flex-wrap:wrap; }
        .adminTitle{ display:flex; flex-direction:column; gap:.15rem; }
        .adminCard{ margin-top: var(--section-gap); }
        .adminLead{ margin: .25rem 0 0; }
        .adminPanel{ margin-top: 1rem; }
        .pageTop .pill { justify-self: start; }

        .formGrid{
            display:grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: .9rem;
        }
        .span2{ grid-column: span 2; }

        .label{
            display:block;
            font-weight: 700;
            margin-bottom: .35rem;
            color: var(--text-strong);
        }
        .input{
            width:100%;
            padding: .75rem .85rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(0,0,0,0.12);
            color: var(--text);
            font: inherit;
            font-size: 16px;
        }

        .actions{ display:flex; gap:.75rem; flex-wrap:wrap; margin-top:.25rem; }
        .status--center { text-align: center; }
        .winnersCard{
            margin-top: var(--section-gap);
            padding: 1.5rem;
        }

        .winnersPanel{
            padding: 1rem;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: rgba(0,0,0,0.20);
        }

        .winnersTableWrap{
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            padding-left: 1.25rem;
            padding-right: .75rem;
            background: rgba(0,0,0,0.10);
        }

        .winnersTable{
            width: 100%;
            border-collapse: separate;
            min-width: 720px;
            border-spacing: 0 .45rem;
            margin: 0;
        }

        .winnersTable th,
        .winnersTable td{
            padding: .7rem .75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            color: var(--text);
            font-size: .98rem;
        }

        .winnersTable th {
            color: var(--text-strong);
            font-weight: 800;
            background: rgba(255, 255, 255, 0.03);
        }

        .winnersTable tbody td{
            border-bottom: 0;
            padding: .65rem 0.75rem;
            background: rgba(0,0,0,0.12);
        }

        .winnersTable tbody tr td:first-child{
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
        }

        .winnersTable tbody tr td:last-child{
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .winnersTable td:last-child{
            padding-right: .6rem;
        }

        .winnersTable th:last-child,
        .winnersTable td:last-child {
            width: 1%;
            white-space: nowrap;
        }

        .winnersTable td:last-child .pill{
            min-width: 6.5rem;
            justify-content: center;
        }

        .tdDate time{
            display: inline-block;
            width: 10ch; /* MM/DD/YYYY */
            white-space: nowrap;
            font-variant-numeric: tabular-nums;
        }

        @media (max-width: 900px){
            .formGrid{ grid-template-columns: 1fr; }
            .span2{ grid-column: span 1; }
        }

        @media (max-width: 680px){
            .actions{
                flex-direction: column;
                align-items: stretch;
            }
            .actions .btn,
            .actions .pill{
                width: 100%;
                justify-content: center;
                text-align: center;
            }
        }
        @media (max-width: 520px){
            .winnersTable th,
            .winnersTable td {
                padding: .6rem .55rem;
            }

            .winnersTable td:nth-child(4),  /* Town */
            .winnersTable th:nth-child(4){
                padding-left: .2rem;
            }

            .winnersTable td:last-child,
            .winnersTable th:last-child{
                padding-left: .45rem;
                padding-right: .2rem;
                width: 1%;
                white-space: nowrap;
            }

            .winnersTable td:last-child .pill{
                padding: .35rem .65rem;
            }
        }
    </style>
</BaseLayout>

