---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import type { D1Database } from "@cloudflare/workers-types";
export const prerender = false;

const id = Astro.params.id!;
const DB = (Astro.locals as any).runtime.env.DB as D1Database;

type Row = {
    id: string;
    title: string;
    kind: string;
    status: string;
    date_start: string | null;
    date_end: string | null;
    is_tbd: number;
    location: string | null;
    summary: string | null;
    url: string | null;
    url_label: string | null;
    poster_key: string | null;
    poster_alt: string | null;
};

const res = await DB.prepare(`
    SELECT id,title,kind,status,date_start,date_end,is_tbd,location,summary,url,url_label,
           poster_key, poster_alt
    FROM events WHERE id = ?
`).bind(id).first<Row>();

if (!res) {
    return new Response(null, { status: 302, headers: { location: "/admin/events?err=notfound" } });
}

const ok = Astro.url.searchParams.get("ok");
const err = Astro.url.searchParams.get("err");
const statusClass =
    ok ? "status--success" :
        err ? "status--error" :
            "status--empty";
const statusMsg =
    ok === "updated" ? "Updated."
        : ok === "poster" ? "Poster uploaded."
            : ok === "created" ? "Created."
                : ok === "deleted" ? "Deleted."
                    : ok === "toggled" ? "Updated status."
                        : err === "invalid" ? "Please check the fields and try again."
                            : err === "server" ? "Server error. Try again."
                                : err === "alt" ? "Alt text must be at least 5 characters."
                                    : err === "file" ? "Please choose a file."
                                        : err === "type" ? "Please upload a JPG, PNG, WEBP, or GIF."
                                            : err === "size" ? "File must be under 8MB."
                                                : err ? "Something went wrong."
                                                    : "";
---

<BaseLayout title={`Edit Event | Admin`}>
    <div class="container" style="--maxw: 900px;">
        <section class="card enter-block" style="margin-top: var(--section-gap);">
            <div class="adminHeader">
                <div class="pageTop">
                    <a class="pill enter-block delay-1" href="/admin/events">← Events</a>
                    <h1 class="h1-tight">Edit event</h1>
                    <p class="muted" style="margin:.2rem 0 0;">ID: <code>{res.id}</code></p>

                    <div id="status" class={`status ${statusClass}`} role="status" aria-live="polite" aria-atomic="true" tabindex="-1">
                        {statusMsg}
                    </div>
                </div>

                <div class="headerActions">
                    <form method="post" action="/api/admin/events/toggle-status">
                        <input type="hidden" name="id" value={res.id} />
                        <input type="hidden" name="next" value={res.status === "published" ? "draft" : "published"} />
                        <button class="pill  enter-block delay-2" type="submit">{res.status === "published" ? "Unpublish" : "Publish"}</button>
                    </form>

                    <form method="post" action="/api/admin/events/delete" onsubmit="return confirm('Delete this event? This cannot be undone.');">
                        <input type="hidden" name="id" value={res.id} />
                        <button class="pill pill--danger enter-block delay-3" type="submit">Delete</button>
                    </form>
                </div>
            </div>

            <div class="panel enter-block delay-4" style="margin-top: 1rem; background: var(--panel-bg-dense);">
                <form method="post" action="/api/admin/events/update" class="form">
                    <input type="hidden" name="id" value={res.id} />

                    <div class="grid">
                        <label class="field">
                            <span class="label">Title *</span>
                            <input name="title" required maxlength="120" value={res.title} />
                        </label>

                        <label class="field">
                            <span class="label">Kind *</span>
                            <select name="kind" required>
                                <option value="Event" selected={res.kind === "Event"}>Event</option>
                                <option value="Meeting" selected={res.kind === "Meeting"}>Meeting</option>
                                <option value="Fundraiser" selected={res.kind === "Fundraiser"}>Fundraiser</option>
                                <option value="Raffle" selected={res.kind === "Raffle"}>Raffle</option>
                            </select>
                        </label>

                        <label class="field">
                            <span class="label">Status</span>
                            <select name="status">
                                <option value="draft" selected={res.status === "draft"}>draft</option>
                                <option value="published" selected={res.status === "published"}>published</option>
                            </select>
                        </label>

                        <label class="field checkbox">
                            <input type="checkbox" name="is_tbd" value="1" id="is_tbd" checked={res.is_tbd === 1} />
                            <span>Planned (Date TBD)</span>
                        </label>

                        <label class="field">
                            <span class="label">Start</span>
                            <input type="datetime-local" name="date_start" id="date_start" value={res.is_tbd ? "" : (res.date_start ?? "")} />
                        </label>

                        <label class="field">
                            <span class="label">End</span>
                            <input type="datetime-local" name="date_end" id="date_end" value={res.is_tbd ? "" : (res.date_end ?? "")} />
                        </label>

                        <label class="field full">
                            <span class="label">Location</span>
                            <input name="location" maxlength="120" value={res.location ?? ""} />
                        </label>

                        <label class="field full">
                            <span class="label">Summary</span>
                            <textarea name="summary" rows="4" maxlength="600">{res.summary ?? ""}</textarea>
                        </label>

                        <label class="field full">
                            <span class="label">Link URL</span>
                            <input name="url" inputmode="url" placeholder="https://..." value={res.url ?? ""} />
                        </label>

                        <label class="field">
                            <span class="label">Link label</span>
                            <input name="url_label" maxlength="40" placeholder="Details" value={res.url_label ?? ""} />
                        </label>
                    </div>

                    <div class="actions">
                        <button class="pill enter-block delay-5" type="submit">Save</button>
                        <a class="pill enter-block delay-6" href="/admin/events">Back</a>
                    </div>
                </form>
            </div>
            <div class="panel enter-block delay-5" style="margin-top: 1rem; background: var(--panel-bg-dense);">
                <h2 class="h2-zero">Poster</h2>
                <p class="muted" style="margin:.35rem 0 1rem;">
                    Upload a poster image for this event (optional).
                </p>

                {res.poster_key ? (
                    <figure class="poster" style="margin:0 0 1rem;">
                        <img
                            src={`/api/events/poster?id=${res.id}`}
                            alt={res.poster_alt ?? res.title}
                            loading="lazy"
                        />
                    </figure>
                ) : null}

                <form method="post" action="/api/admin/events/poster" enctype="multipart/form-data" class="form" data-file-form>
                    <input type="hidden" name="id" value={res.id} />

                    <div class="field field--file full">
                        <label class="labelRow" for="poster">
                            Poster
                            <span class="req" aria-hidden="true">*</span>
                            <span class="srOnly">(required)</span>
                        </label>

                        <input
                            id="poster"
                            class="fileInput"
                            name="poster"
                            type="file"
                            accept="image/*"
                            required
                            data-file-input
                        />

                        <div class="fileUi enter-block delay-6" role="group">
                            <button class="pill fileBtn" type="button" data-file-btn>
                                Choose file
                            </button>

                            <span class="fileName muted" data-file-name>
                              No file chosen
                            </span>
                        </div>
                    </div>

                    <label class="field full">
                        <span class="label">Poster alt text *</span>
                        <input name="alt" minlength="5" required value={res.poster_alt ?? ""} />
                    </label>

                    <div class="actions">
                        <button class="pill enter-block delay-7" type="submit">Upload poster</button>
                    </div>
                </form>
            </div>
        </section>
    </div>

    <script type="module">
        // TBD toggle
        const tbd = document.getElementById("is_tbd");
        const start = document.getElementById("date_start");
        const end = document.getElementById("date_end");

        const form = document.querySelector("form.form");
        const status = document.getElementById("status");

        function nowChicagoDatetimeMin() {
            const parts = new Intl.DateTimeFormat("en-US", {
                timeZone: "America/Chicago",
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
            }).formatToParts(new Date());

            const get = (t) => parts.find((p) => p.type === t)?.value ?? "";
            return `${get("year")}-${get("month")}-${get("day")}T${get("hour")}:${get("minute")}`;
        }

        function showStatus(msg) {
            if (!(status instanceof HTMLElement)) return;
            status.textContent = msg;
            status.classList.remove("status--success");
            status.classList.add("status--error");
            status.focus?.();
        }

        function syncDateConstraintsEdit() {
            if (!(tbd instanceof HTMLInputElement)) return;
            if (!(start instanceof HTMLInputElement)) return;
            if (!(end instanceof HTMLInputElement)) return;

            if (tbd.checked) {
                start.removeAttribute("min");
                start.removeAttribute("max");
                end.removeAttribute("min");
                end.removeAttribute("max");
                return;
            }

            // IMPORTANT: On edit, do NOT set min=now (would break editing older events).
            // Only enforce Start/End ordering via min/max.
            if (start.value) end.min = start.value; else end.removeAttribute("min");
            if (end.value) start.max = end.value; else start.removeAttribute("max");

            if (start.value && end.value && end.value < start.value) {
                // keep user from leaving it invalid after edits
                end.value = start.value;
            }
        }

        function syncTbd() {
            if (!(tbd instanceof HTMLInputElement)) return;
            if (!(start instanceof HTMLInputElement)) return;
            if (!(end instanceof HTMLInputElement)) return;

            const on = tbd.checked;
            start.disabled = on;
            end.disabled = on;
            if (on) { start.value = ""; end.value = ""; }
        }
        tbd?.addEventListener("change", syncTbd);
        syncTbd();

        start?.addEventListener("change", syncDateConstraintsEdit);
        end?.addEventListener("change", syncDateConstraintsEdit);
        tbd?.addEventListener("change", syncDateConstraintsEdit);
        syncDateConstraintsEdit();

        form?.addEventListener("submit", (e) => {
            if (!(tbd instanceof HTMLInputElement)) return;
            if (!(start instanceof HTMLInputElement)) return;
            if (!(end instanceof HTMLInputElement)) return;

            if (tbd.checked) return;

            const s = start.value.trim();
            const en = end.value.trim();

            if (!s) {
                e.preventDefault();
                showStatus("Start date is required unless Planned (Date TBD) is checked.");
                return;
            }

            // On edit: block user from saving an event in the past if you truly want that rule.
            // This will prevent “fixing” old events unless they toggle to TBD or move it to future.
            const minNow = nowChicagoDatetimeMin();
            if (s < minNow) {
                e.preventDefault();
                showStatus("Start date cannot be in the past.");
                return;
            }

            if (en && en < s) {
                e.preventDefault();
                showStatus("End date cannot be before Start date.");
            }
        });

        // File chooser UI (scoped to the poster form)
        const root = document.querySelector("[data-file-form]");
        const input = root?.querySelector("[data-file-input]");
        const btn = root?.querySelector("[data-file-btn]");
        const name = root?.querySelector("[data-file-name]");

        btn?.addEventListener("click", () => (input instanceof HTMLInputElement) && input.click());
        input?.addEventListener("change", () => {
            if (input instanceof HTMLInputElement) {
                const file = input.files?.[0];
                if (name) name.textContent = file ? file.name : "No file chosen";
            }
        });
        // Auto-clear ok/err query params (keeps refresh from re-showing messages)
        (() => {
            const u = new URL(window.location.href);
            let changed = false;

            if (u.searchParams.has("ok")) { u.searchParams.delete("ok"); changed = true; }
            if (u.searchParams.has("err")) { u.searchParams.delete("err"); changed = true; }

            if (changed) {
                const next = u.pathname + (u.searchParams.toString() ? `?${u.searchParams.toString()}` : "") + u.hash;
                window.history.replaceState({}, "", next);
            }
        })();
    </script>
    <style>
        .adminHeader{ display:flex; justify-content:space-between; align-items:flex-end; gap:1rem; flex-wrap:wrap; }
        .pageTop .pill { justify-self: start; }
        .headerActions{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
        .grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .9rem; }
        .grid > * { min-width: 0; }
        .full{ grid-column: 1 / -1; }
        .field{ display:grid; gap:.35rem; min-width: 0; }
        .label{ font-weight: 800; color: var(--text); }
        .labelRow{
            display: block;
            max-width: 100%;
            overflow-wrap: anywhere;
        }
        /* Prevent long labels/titles from overflowing */
        .label,
        .labelRow{
            max-width: 100%;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        /* Critical: allow grid/flex children to shrink */
        .field,
        .pageTop,
        .eventMain,
        .eventTitleRow,
        .fileUi{
            min-width: 0;
        }
        /* Select styling: darker “glass” */
        select{
            background: var(--glass-light);
            border-color: var(--border-strong);
            color: var(--text-bright);
            /* make the arrow look consistent without changing the menu */
            appearance: none;
            background-image:
                    linear-gradient(45deg, transparent 50%, var(--text-soft) 50%),
                    linear-gradient(135deg, var(--text-soft) 50%, transparent 50%);
            background-position:
                    calc(100% - 18px) calc(50% - 3px),
                    calc(100% - 12px) calc(50% - 3px);
            background-size: 6px 6px;
            background-repeat: no-repeat;
            padding-right: 2.25rem;
        }

        /* Some browsers ignore option styling; still helps where supported */
        select option{
            background: var(--surface);
            color: var(--text);
        }
        .checkbox{ align-items:center; grid-template-columns: auto 1fr; gap:.6rem; }
        .actions{ display:flex; gap:.6rem; flex-wrap:wrap; margin-top: 1rem; }
        .fileInput{
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        .fileUi{
            display: flex;
            align-items: center;
            gap: .75rem;
            padding: .65rem .75rem;
            border-radius: 12px;
            border: 1px solid var(--border-strong);
            background: var(--glass-light);
            width: 100%;
            min-width: 0;
            max-width: 100%;
        }

        .fileName{
            flex: 1 1 auto;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .fileBtn{
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            flex: 0 0 auto;
        }
        input, select, textarea {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        input[type="datetime-local"]{ min-width: 0; }
        @media (max-width: 720px){ .grid{ grid-template-columns: 1fr; } }
    </style>
</BaseLayout>
