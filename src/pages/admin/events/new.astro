---
import BaseLayout from "../../../layouts/BaseLayout.astro";
export const prerender = false;

const ok = Astro.url.searchParams.get("ok");
const err = Astro.url.searchParams.get("err");
const statusClass =
    ok ? "status--success" :
        err ? "status--error" :
            "status--empty";
const statusMsg =
    ok === "created" ? "Created." :
        err === "invalid" ? "Please check the fields and try again." :
            err === "server" ? "Server error. Try again." :
                err ? "Something went wrong." : "";
---

<BaseLayout title="New Event | Admin">
    <div class="container" style="--maxw: 900px;">
        <section class="card enter-block" style="margin-top: var(--section-gap);">
            <div class="adminHeader">
                <div class="pageTop">
                    <div class="pageTopRow">
                        <a class="pill enter-block delay-1" href="/admin/events">← Events</a>

                        <form class="logoutForm enter-block delay-1" method="post" action="/api/admin/logout">
                            <button class="btn" type="submit">Log out</button>
                        </form>
                    </div>

                    <h1 class="h1-tight">New event</h1>
                    <p class="lead" style="margin:0;">Create an event and publish when ready.</p>

                    <div id="status" class={`status ${statusClass}`} role="status" aria-live="polite" aria-atomic="true" tabindex="-1">
                        {statusMsg}
                    </div>
                </div>
            </div>

            <div class="panel enter-block delay-2" style="margin-top: 1rem; background: var(--panel-bg-dense);">
                <form method="post" action="/api/admin/events/create" class="form">
                    <div class="grid">
                        <label class="field">
                            <span class="label">Title *</span>
                            <input name="title" required maxlength="120" />
                        </label>

                        <label class="field">
                            <span class="label">Kind *</span>
                            <select name="kind" required>
                                <option value="Event">Event</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Fundraiser">Fundraiser</option>
                                <option value="Raffle">Raffle</option>
                            </select>
                        </label>

                        <label class="field">
                            <span class="label">Status</span>
                            <select name="status">
                                <option value="draft">draft</option>
                                <option value="published">published</option>
                            </select>
                        </label>

                        <label class="field checkbox">
                            <input type="checkbox" name="is_tbd" value="1" id="is_tbd" />
                            <span>Planned (Date TBD)</span>
                        </label>

                        <label class="field">
                            <span class="label">Start</span>
                            <input type="datetime-local" name="date_start" id="date_start" />
                        </label>

                        <label class="field">
                            <span class="label">End</span>
                            <input type="datetime-local" name="date_end" id="date_end" />
                        </label>

                        <label class="field full">
                            <span class="label">Location</span>
                            <input name="location" maxlength="120" />
                        </label>

                        <label class="field full">
                            <span class="label">Summary</span>
                            <textarea name="summary" rows="4" maxlength="600"></textarea>
                        </label>

                        <label class="field full">
                            <span class="label">Link URL</span>
                            <input name="url" inputmode="url" placeholder="https://..." />
                        </label>

                        <label class="field">
                            <span class="label">Link label</span>
                            <input name="url_label" maxlength="40" placeholder="Details" />
                        </label>
                    </div>

                    <div class="actions">
                        <button class="pill  enter-block delay-3" type="submit">Create</button>
                        <a class="pill  enter-block delay-4" href="/admin/events">Cancel</a>
                    </div>
                </form>
            </div>
        </section>
    </div>

    <script type="module">
        const tbd = document.getElementById("is_tbd");
        const start = document.getElementById("date_start");
        const end = document.getElementById("date_end");
        const form = document.querySelector("form.form");
        const status = document.getElementById("status");

        function nowChicagoDatetimeMin() {
            const parts = new Intl.DateTimeFormat("en-US", {
                timeZone: "America/Chicago",
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
            }).formatToParts(new Date());

            const get = (t) => parts.find((p) => p.type === t)?.value ?? "";
            return `${get("year")}-${get("month")}-${get("day")}T${get("hour")}:${get("minute")}`;
        }

        function showStatus(msg) {
            if (!(status instanceof HTMLElement)) return;
            status.textContent = msg;
            status.classList.remove("status--success");
            status.classList.add("status--error");
            status.focus?.();
        }

        function clearStatus() {
            if (!(status instanceof HTMLElement)) return;
            // leave whatever server rendered if you prefer; I’m clearing on user interaction only
            // status.textContent = "";
        }

        function syncTbdAndConstraints() {
            if (!(tbd instanceof HTMLInputElement)) return;
            if (!(start instanceof HTMLInputElement)) return;
            if (!(end instanceof HTMLInputElement)) return;

            const on = tbd.checked;
            start.disabled = on;
            end.disabled = on;

            if (on) {
                start.value = "";
                end.value = "";
                start.removeAttribute("min");
                start.removeAttribute("max");
                end.removeAttribute("min");
                end.removeAttribute("max");
                return;
            }

            // New event: prevent past picks
            const minNow = nowChicagoDatetimeMin();
            start.min = minNow;
            end.min = minNow;

            // Cross-constraints
            if (start.value) end.min = start.value;
            if (end.value) start.max = end.value;

            // If user made them invalid, clear the invalid one (optional but helpful)
            if (start.value && end.value && end.value < start.value) {
                end.value = start.value;
            }
        }

        tbd?.addEventListener("change", () => {
            clearStatus();
            syncTbdAndConstraints();
        });

        start?.addEventListener("change", () => {
            clearStatus();
            syncTbdAndConstraints();
        });

        end?.addEventListener("change", () => {
            clearStatus();
            syncTbdAndConstraints();
        });

        // Block submit if invalid
        form?.addEventListener("submit", (e) => {
            if (!(tbd instanceof HTMLInputElement)) return;
            if (!(start instanceof HTMLInputElement)) return;
            if (!(end instanceof HTMLInputElement)) return;

            if (tbd.checked) return;

            const s = start.value.trim();
            const en = end.value.trim();

            if (!s) {
                e.preventDefault();
                showStatus("Start date is required unless Planned (Date TBD) is checked.");
                return;
            }

            const minNow = nowLocalDatetimeMin();
            if (s < minNow) {
                e.preventDefault();
                showStatus("Start date cannot be in the past.");
                return;
            }

            if (en) {
                if (en < minNow) {
                    e.preventDefault();
                    showStatus("End date cannot be in the past.");
                    return;
                }
                if (en < s) {
                    e.preventDefault();
                    showStatus("End date cannot be before Start date.");
                }
            }
        });

        syncTbdAndConstraints();

        // Auto-clear ok/err query params (keeps refresh from re-showing messages)
        (() => {
            const u = new URL(window.location.href);
            let changed = false;

            if (u.searchParams.has("ok")) { u.searchParams.delete("ok"); changed = true; }
            if (u.searchParams.has("err")) { u.searchParams.delete("err"); changed = true; }

            if (changed) {
                const next = u.pathname + (u.searchParams.toString() ? `?${u.searchParams.toString()}` : "") + u.hash;
                window.history.replaceState({}, "", next);
            }
        })();
    </script>

    <style>
        .adminHeader{ display:block; }
        .pageTop{ display:grid; gap:.6rem; width:100%; min-width:0; }
        .pageTopRow{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; width:100%; min-width:0; }
        .logoutForm{ margin:0; }
        .logoutForm .btn{ padding: .6rem .9rem; border-radius: 999px; white-space: nowrap; }
        .grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .9rem; }
        .grid > * { min-width: 0; }
        .full{ grid-column: 1 / -1; }
        .field{ display:grid; gap:.35rem; min-width: 0; }
        .label{ font-weight: 800; color: var(--text); }
        /* Prevent long labels/titles from overflowing */
        .label,
        .labelRow{
            max-width: 100%;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        /* Critical: allow grid/flex children to shrink */
        .field,
        .pageTop,
        .eventMain,
        .eventTitleRow,
        .fileUi{
            min-width: 0;
        }
        /* Select styling: darker “glass” */
        select{
            background: var(--glass-light);
            border-color: var(--border-strong);
            color: var(--text-bright);
            /* make the arrow look consistent without changing the menu */
            appearance: none;
            background-image:
                    linear-gradient(45deg, transparent 50%, var(--text-soft) 50%),
                    linear-gradient(135deg, var(--text-soft) 50%, transparent 50%);
            background-position:
                    calc(100% - 18px) calc(50% - 3px),
                    calc(100% - 12px) calc(50% - 3px);
            background-size: 6px 6px;
            background-repeat: no-repeat;
            padding-right: 2.25rem;
        }

        /* Some browsers ignore option styling; still helps where supported */
        select option{
            background: var(--surface);
            color: var(--text);
        }
        .checkbox{ align-items:center; grid-template-columns: auto 1fr; gap:.6rem; }
        .actions{ display:flex; gap:.6rem; flex-wrap:wrap; margin-top: 1rem; }
        input, select, textarea {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        input[type="datetime-local"]{ min-width: 0; }
        @media (max-width: 720px){ .grid{ grid-template-columns: 1fr; } }
    </style>
</BaseLayout>
