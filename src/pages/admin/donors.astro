---
import BaseLayout from "../../layouts/BaseLayout.astro";

export const prerender = false;

const url = new URL(Astro.request.url);
const ok = url.searchParams.get("ok");
const err = url.searchParams.get("err");

// Fetch donors for admin list
const DB = Astro.locals.runtime.env.DB;
const donors = (await DB
    .prepare(
        `SELECT id, name, display_name, in_memory_of, amount_cents
     FROM donors
     ORDER BY amount_cents DESC, id DESC`
    )
    .all()).results ?? [];
---

<BaseLayout title="Admin Donors | Friends of Lake Henry">
    <div class="container" style="--maxw: 1100px;">
        <section class="card adminCard enter-block">
            <div class="adminHeader">
                <div class="pageTop">
                    <div class="pageTopRow">
                        <a class="pill enter-block delay-1" href="/admin">ADMIN</a>

                        <form class="logoutForm enter-block delay-1" method="post" action="/api/admin/logout">
                            <button class="btn" type="submit">Log out</button>
                        </form>
                    </div>
                    <h1 class="h1-tight">Donors</h1>
                    <p class="lead adminLead">Add a donor to the public donors list.</p>
                </div>
            </div>

            <div class="panel adminPanel enter-block delay-2">
                <h2 class="subhead">Add donor</h2>
                {ok === "1" && (
                        <div class="status status--success" role="status">
                            Donor added.
                        </div>
                )}

                {ok === "deleted" && (
                        <div class="status status--success" role="status">
                            Donor deleted.
                        </div>
                )}

                {err === "name" && (
                        <div class="status status--error" role="status">
                            Name / Company must be at least 2 characters.
                        </div>
                )}

                {err === "amount" && (
                        <div class="status status--error" role="status">
                            Please enter a valid amount (example: 50.00).
                        </div>
                )}

                {err === "server" && (
                        <div class="status status--error" role="status">
                            Something went wrong. Please try again.
                        </div>
                )}
                <form class="form" method="post" action="/api/admin/donors">
                    <div class="grid2">
                        <label class="field">
                            <span class="labelRow">Name / Company<span class="req">*</span></span>
                            <input name="name" required />
                        </label>

                        <label class="field">
                            <span class="labelRow">Amount (USD)<span class="req">*</span></span>
                            <input name="amount" type="number" min="0.01" step="0.01" placeholder="50.00" required />
                        </label>
                    </div>

                    <div class="grid2">
                        <label class="field">
                            <span class="labelRow">In memory of (optional)</span>
                            <input name="inMemoryOf" placeholder="John Doe" />
                        </label>

                        <label class="field">
                            <span class="labelRow">Display name (optional)</span>
                            <input name="displayName" placeholder="Name as shown publicly" />
                        </label>
                    </div>

                    <div class="ctaRow enter-block delay-3">
                        <button class="btn" type="submit">Add donor</button>
                        <a class="btn" href="/donors">View donors</a>
                    </div>

                    <p class="fine muted">Changes apply immediately after submission.</p>
                </form>
            </div>
            <div class="panel adminPanel enter-block delay-3" style="margin-top: 1rem;">
                <h2 class="subhead">Manage donors</h2>
                <p class="fine muted">Delete removes the donor from the public list immediately.</p>

                <div class="donorList  enter-block delay-4" role="list">
                    {donors.length === 0 ? (
                            <p class="muted">No donors yet.</p>
                    ) : (
                        donors.map((d: any) => (
                            <div class="donorRow" role="listitem">
                                <div class="donorMeta">
                                    <div class="donorName">
                                        {d.display_name || d.name}
                                        {d.in_memory_of ? <span class="muted"> â€” In memory of {d.in_memory_of}</span> : null}
                                    </div>
                                    <div class="donorAmt">
                                        ${(Number(d.amount_cents) / 100).toFixed(2)}
                                    </div>
                                </div>

                                <form method="post" action="/api/admin/donors/delete" class="donorActions">
                                    <input type="hidden" name="id" value={d.id} />
                                    <button
                                        class="btn"
                                        type="submit"
                                        data-confirm={`Delete donor "${(d.display_name || d.name) ?? "this donor"}"? This cannot be undone.`}
                                    >
                                        Delete
                                    </button>
                                </form>
                            </div>
                        ))
                    )}
                </div>
            </div>
        </section>
    </div>
    <script is:inline>
        (() => {
            // Clean ok/err from URL after render
            const url = new URL(window.location.href);
            if (url.searchParams.has("ok") || url.searchParams.has("err")) {
                url.searchParams.delete("ok");
                url.searchParams.delete("err");
                window.history.replaceState({}, "", url.pathname + url.search);
            }

            // Prevent mousewheel changing number inputs
            document.addEventListener(
                "wheel",
                (e) => {
                    const el = e.target;
                    if (el instanceof HTMLInputElement && el.type === "number" && document.activeElement === el) {
                        el.blur();
                    }
                },
                { passive: true }
            );

            // Confirm only when the clicked submit button has data-confirm
            document.addEventListener("submit", (e) => {
                const form = e.target;
                if (!(form instanceof HTMLFormElement)) return;

                const submitter = e.submitter;
                if (!(submitter instanceof HTMLElement)) return;

                const msg = submitter.getAttribute("data-confirm");
                if (!msg) return;

                if (!confirm(msg)) e.preventDefault();
            });
        })();
    </script>
    <style>
        .adminCard{ margin-top: var(--section-gap); }
        .adminPanel{ margin-top: 1rem; }
        .adminLead{ margin: 0; }
        .adminHeader{ display: block; }
        .pageTop{ display: grid; gap: .6rem; width: 100%; }

        .pageTopRow{
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: .75rem;
            width: 100%;
        }

        .logoutForm{ margin: 0; }
        .logoutForm .btn{ padding: .6rem .9rem; border-radius: 999px; white-space: nowrap; }
        .donorList { display: grid; gap: .75rem; margin-top: .75rem; }
        .donorRow { display:flex; align-items:center; justify-content:space-between; gap: 1rem; padding: .75rem; border: 1px solid var(--panel-border); border-radius: 12px; background: var(--panel-bg); }
        .donorMeta { display:flex; align-items:baseline; justify-content:space-between; gap: 1rem; flex: 1; }
        .donorAmt { font-weight: 750; white-space: nowrap; }
        .donorActions { margin: 0; }
        .subhead{ margin: 0 0 .4rem; font-size: 1.25rem; color: var(--text-strong); }
        .form { margin-top: 1rem; display: grid; gap: 1rem; }
        .grid2 { display:grid; gap: 1rem; grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .field { display: grid; gap: .4rem; }
        .labelRow{ display:inline-flex; gap:.25rem; font-weight: 750; }
        .ctaRow{ display:flex; gap:.75rem; flex-wrap:wrap; margin-top:.35rem; }
        .fine{ margin: .65rem 0 0; font-size: .95rem; color: var(--text-soft); opacity: .9; }

        @media (max-width: 720px){ .grid2{ grid-template-columns: 1fr; } }
        @media (max-width: 520px){
            .ctaRow{ flex-direction: column; align-items: stretch; }
            .ctaRow .btn{ width: 100%; justify-content: center; }
        }
    </style>
</BaseLayout>

